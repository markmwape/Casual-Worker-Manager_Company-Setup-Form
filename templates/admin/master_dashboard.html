<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Enhanced Custom CSS for modern design and better UX */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
            will-change: transform, box-shadow;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        .metric-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        }
        .metric-card.primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }
        .metric-card.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .metric-card.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        .metric-card.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        .sidebar {
            background: linear-gradient(180deg, #1e293b 0%, #334155 100%);
            backdrop-filter: blur(10px);
        }
        .chart-container {
            position: relative;
            height: 350px;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .table-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid #e2e8f0;
            backdrop-filter: blur(10px);
        }
        .table-container .overflow-x-auto {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .table-container table {
            border-collapse: separate;
            border-spacing: 0;
        }
        .table-container th,
        .table-container td {
            border-right: 1px solid #e2e8f0;
            vertical-align: top;
        }
        .table-container th:last-child,
        .table-container td:last-child {
            border-right: none;
        }
        .table-header {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-bottom: 2px solid #e2e8f0;
        }
        .table-row {
            transition: all 0.3s ease;
            position: relative;
        }
        .table-row:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .table-row::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            transition: width 0.3s ease;
        }
        .table-row:hover::before {
            width: 4px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
        }
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }
        .btn-primary:hover::before {
            left: 100%;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }
        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }
        .search-bar {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 14px 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            width: 100%;
        }
        .search-bar:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1), 0 8px 25px rgba(0,0,0,0.15);
            transform: scale(1.02);
        }
        .alert-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            animation: slideIn 0.5s ease-out;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2);
        }
        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metric-label {
            font-size: 0.875rem;
            font-weight: 600;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .metric-change {
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            margin-top: 6px;
        }
        .metric-change.positive {
            color: #10b981;
        }
        .metric-change.negative {
            color: #ef4444;
        }
        .nav-item {
            transition: all 0.3s ease;
            border-radius: 12px;
            margin: 8px 0;
            position: relative;
            overflow: hidden;
        }
        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        .nav-item:hover::before,
        .nav-item.active::before {
            transform: scaleY(1);
        }
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(8px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .dropdown-menu {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        .dropdown-item {
            padding: 12px 20px;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin: 4px 8px;
        }
        .dropdown-item:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            transform: translateX(4px);
        }
        
        /* Quick Action Buttons */
        .quick-action {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center;
        }
        .quick-action:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        /* Enhanced Cards */
        .insight-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.8) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            padding: 28px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .insight-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8, #10b981);
        }
        .insight-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }
        
        /* Progress Bars */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            border-radius: 4px;
            transition: width 0.8s ease;
            position: relative;
        }
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Section Headers */
        .section-header {
            position: relative;
            padding: 24px 0;
            margin-bottom: 32px;
        }
        .section-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            border-radius: 2px;
        }
        
        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 8px 30px rgba(59, 130, 246, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
            cursor: pointer;
            border: 3px solid rgba(255, 255, 255, 0.2);
        }
        .fab:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.5);
        }
        
        /* Task Analytics Styles */
        .task-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
        }
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        .task-priority {
            position: absolute;
            top: 0;
            right: 0;
            padding: 8px 16px;
            border-radius: 0 16px 0 16px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .task-priority.high {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .task-priority.medium {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        .task-priority.low {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .metric-value {
                font-size: 1.8rem;
            }
            .chart-container {
                height: 280px;
                padding: 15px;
            }
            .nav-item:hover {
                transform: none;
            }
            .table-row:hover {
                transform: none;
            }
            .fab {
                bottom: 20px;
                right: 20px;
                width: 56px;
                height: 56px;
            }
            .insight-card {
                padding: 20px;
            }
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar Navigation -->
    <div class="flex h-screen">
        <div class="sidebar w-64 min-h-screen p-6 text-white">
            <div class="mb-8">
                <h1 class="text-2xl font-bold mb-2">
                    <i class="fas fa-crown mr-2"></i>
                    Master Admin
                </h1>
                <p class="text-gray-300 text-sm">Platform Overview</p>
            </div>
            
            <nav class="space-y-2">
                <a href="#overview" onclick="scrollToSection('overview')" class="nav-item active flex items-center p-3 text-white">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    Dashboard Overview
                </a>
                <a href="#workspace-analytics" onclick="scrollToSection('workspace-analytics')" class="nav-item flex items-center p-3 text-gray-300 hover:text-white">
                    <i class="fas fa-building mr-3"></i>
                    Workspace Analytics
                </a>
                <a href="#task-analytics" onclick="scrollToSection('task-analytics')" class="nav-item flex items-center p-3 text-gray-300 hover:text-white">
                    <i class="fas fa-tasks mr-3"></i>
                    Task Analytics
                </a>
                <a href="#reports" onclick="scrollToSection('reports')" class="nav-item flex items-center p-3 text-gray-300 hover:text-white">
                    <i class="fas fa-chart-pie mr-3"></i>
                    User Reports
                </a>
                <a href="/admin/master-admins" class="nav-item flex items-center p-3 text-gray-300 hover:text-white">
                    <i class="fas fa-user-shield mr-3"></i>
                    Master Admins
                </a>
                
                <!-- Quick Actions Dropdown -->
                <div class="mt-6">
                    <p class="text-gray-400 text-xs uppercase tracking-wider font-semibold mb-3">Quick Actions</p>
                    <div class="space-y-1">
                        <button onclick="showTaskDetails('high-engagement')" class="nav-item flex items-center p-3 text-gray-300 hover:text-white w-full text-left">
                            <i class="fas fa-fire mr-3 text-red-400"></i>
                            High Engagement Tasks
                        </button>
                        <button onclick="exportDashboardData()" class="nav-item flex items-center p-3 text-gray-300 hover:text-white w-full text-left">
                            <i class="fas fa-download mr-3 text-green-400"></i>
                            Export Analytics
                        </button>
                        <button onclick="refreshDashboard()" class="nav-item flex items-center p-3 text-gray-300 hover:text-white w-full text-left">
                            <i class="fas fa-sync-alt mr-3 text-blue-400"></i>
                            Refresh Data
                        </button>
                    </div>
                </div>
            </nav>
            
            <div class="mt-auto pt-8">
                <div class="bg-white bg-opacity-10 rounded-lg p-4">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium">Master Admin</p>
                            <p class="text-xs text-gray-300">markbmwape@gmail.com</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-auto">
            <!-- Header -->
            <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Dashboard Overview</h2>
                        <p class="text-gray-600">Real-time platform insights and analytics</p>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <!-- Search Bar -->
                        <div class="relative">
                            <input type="text" id="searchInput" placeholder="Search workspaces, users..." 
                                   class="search-bar w-64 pl-10" onkeyup="performSearch()">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        
                        <!-- Export Dropdown -->
                        <div class="relative">
                            <button onclick="toggleExportDropdown()" 
                                    class="btn-primary flex items-center">
                                <i class="fas fa-download mr-2"></i>
                                Export Data
                                <i class="fas fa-chevron-down ml-2"></i>
                            </button>
                            <div id="exportDropdown" class="dropdown-menu absolute right-0 mt-2 hidden w-48">
                                <a href="/admin/export/workspaces" class="dropdown-item flex items-center">
                                    <i class="fas fa-building mr-2"></i>
                                    Export Workspaces
                                </a>
                                <a href="/admin/export/users" class="dropdown-item flex items-center">
                                    <i class="fas fa-users mr-2"></i>
                                    Export Users
                                </a>
                                <a href="/admin/export/revenue" class="dropdown-item flex items-center">
                                    <i class="fas fa-dollar-sign mr-2"></i>
                                    Export Revenue
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Dashboard Content -->
            <!-- Dashboard Content -->
            <div class="p-6 space-y-6">
                <!-- Enhanced Key Metrics Cards -->
                <div id="overview" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6">
                    <div class="metric-card primary rounded-xl p-6 card-hover fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="metric-label">Total Workspaces</p>
                                <p class="metric-value">{{ total_workspaces }}</p>
                                <p class="metric-change positive">
                                    <i class="fas fa-arrow-up mr-1"></i>
                                    Active Platform
                                </p>
                            </div>
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-building text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="metric-card success rounded-xl p-6 card-hover fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="metric-label">Total Users</p>
                                <p class="metric-value">{{ total_users }}</p>
                                <p class="metric-change positive">
                                    <i class="fas fa-arrow-up mr-1"></i>
                                    {{ active_users_7d }} this week
                                </p>
                            </div>
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-users text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="metric-card warning rounded-xl p-6 card-hover fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="metric-label">Total Workers</p>
                                <p class="metric-value">{{ total_workers }}</p>
                                <p class="metric-change positive">
                                    <i class="fas fa-arrow-up mr-1"></i>
                                    {{ recent_workers }} this week
                                </p>
                            </div>
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-hard-hat text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="metric-card danger rounded-xl p-6 card-hover fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="metric-label">Tasks This Month</p>
                                <p class="metric-value">{{ tasks_this_month }}</p>
                                <p class="metric-change {% if task_growth_percent >= 0 %}positive{% else %}negative{% endif %}">
                                    <i class="fas fa-arrow-{% if task_growth_percent >= 0 %}up{% else %}down{% endif %} mr-1"></i>
                                    {% if task_growth_percent >= 0 %}+{% endif %}{{ "%.1f"|format(task_growth_percent) }}%
                                </p>
                            </div>
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-tasks text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="metric-card rounded-xl p-6 card-hover fade-in" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white;">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="metric-label">Revenue (Monthly)</p>
                                <p class="metric-value">${{ "%.2f"|format(estimated_revenue) }}</p>
                                <p class="metric-change positive">
                                    <i class="fas fa-dollar-sign mr-1"></i>
                                    {{ active_subscriptions }} active
                                </p>
                            </div>
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-chart-line text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="metric-card rounded-xl p-6 card-hover fade-in" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white;">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="metric-label">Total Companies</p>
                                <p class="metric-value">{{ total_companies }}</p>
                                <p class="metric-change positive">
                                    <i class="fas fa-building mr-1"></i>
                                    Active Clients
                                </p>
                            </div>
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-industry text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Business Intelligence Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">
                                <i class="fas fa-clock mr-2 text-blue-500"></i>
                                Recent Activity
                            </h3>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">New Users (7 days)</span>
                                <span class="font-semibold text-blue-600">{{ recent_users }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">New Tasks (7 days)</span>
                                <span class="font-semibold text-green-600">{{ recent_tasks }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">New Workers (7 days)</span>
                                <span class="font-semibold text-orange-600">{{ recent_workers }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">
                                <i class="fas fa-chart-pie mr-2 text-green-500"></i>
                                Subscription Status
                            </h3>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Active Subscriptions</span>
                                <span class="font-semibold text-green-600">{{ active_subscriptions }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Free Trials</span>
                                <span class="font-semibold text-blue-600">{{ free_trials }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Failed Payments</span>
                                <span class="font-semibold text-red-600">{{ failed_payments }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">
                                <i class="fas fa-trophy mr-2 text-yellow-500"></i>
                                Top Performers
                            </h3>
                        </div>
                        <div class="space-y-2">
                            {% for workspace_data in top_workspaces_by_tasks[:3] %}
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 text-sm truncate">{{ workspace_data.workspace.name }}</span>
                                <span class="font-semibold text-purple-600 text-sm">{{ workspace_data.task_count }} tasks</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">
                                <i class="fas fa-fire mr-2 text-red-500"></i>
                                Most Active Workspace
                            </h3>
                        </div>
                        {% if most_active_workspace %}
                        <div class="space-y-2">
                            <div class="font-semibold text-gray-900 truncate">{{ most_active_workspace.workspace.name }}</div>
                            <div class="text-sm text-gray-600">
                                <div>{{ most_active_workspace.worker_count }} workers</div>
                                <div>{{ most_active_workspace.task_count }} total tasks</div>
                                <div>{{ most_active_workspace.tasks_this_month }} tasks this month</div>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center text-gray-500 text-sm">No activity data</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Charts Section -->
                <div id="analytics" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Industry Distribution -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">
                                <i class="fas fa-industry mr-2 text-blue-500"></i>
                                Industry Distribution
                            </h3>
                            <div class="text-sm text-gray-500">{{ industry_stats|length }} industries</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="industryChart"></canvas>
                        </div>
                    </div>

                    <!-- Country Distribution -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">
                                <i class="fas fa-globe mr-2 text-green-500"></i>
                                Country Distribution
                            </h3>
                            <div class="text-sm text-gray-500">{{ country_stats|length }} countries</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="countryChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- User Growth Chart -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-chart-line mr-2 text-purple-500"></i>
                            User Growth Trend
                        </h3>
                        <div class="flex space-x-2">
                            <button onclick="changeTimePeriod('7d')" id="btn7d" class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-lg transition-colors hover:bg-blue-200">7 Days</button>
                            <button onclick="changeTimePeriod('30d')" id="btn30d" class="px-3 py-1 text-sm bg-gray-100 text-gray-600 rounded-lg transition-colors hover:bg-gray-200">30 Days</button>
                            <button onclick="changeTimePeriod('1y')" id="btn1y" class="px-3 py-1 text-sm bg-gray-100 text-gray-600 rounded-lg transition-colors hover:bg-gray-200">1 Year</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="userGrowthChart"></canvas>
                    </div>
                </div>

                <!-- Recent Workspaces -->
                                <!-- Enhanced Workspaces Table -->
                <div id="workspace-analytics" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-4">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-building mr-2 text-orange-500"></i>
                            Enhanced Workspace Analytics
                        </h3>
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                            <div class="text-sm text-gray-500">{{ enhanced_workspaces|length }} workspaces shown</div>
                            <div class="flex items-center flex-wrap gap-2 text-sm">
                                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                                    <i class="fas fa-chart-line mr-1"></i>{{ high_activity_workspaces }} high activity
                                </span>
                                <span class="px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-medium">
                                    <i class="fas fa-pause mr-1"></i>{{ inactive_workspaces }} inactive
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-max">
                                <thead class="table-header">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-0 w-48">
                                            Workspace
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-0 w-28">
                                            Industry
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-0 w-24">
                                            Country
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-0 w-52">
                                            Company Email
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-0 w-40">
                                            Company Phone
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-0 w-20">
                                            Users
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-0 w-24">
                                            Workers
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-0 w-24">
                                            Tasks
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-0 w-28">
                                            This Month
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-0 w-32">
                                            Attendance Days
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-0 w-32">
                                            Completion Rate
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-0 w-28">
                                            Subscription
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-0 w-28">
                                            Access Status
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-0 w-40">
                                            Actions
                                        </th>
                                    </tr>
                                </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for item in enhanced_workspaces %}
                                <tr class="table-row">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                                <i class="fas fa-building text-blue-600"></i>
                                            </div>
                                            <div>
                                                <div class="text-sm font-medium text-gray-900">{{ item.workspace.name }}</div>
                                                <div class="text-sm text-gray-500">{{ item.workspace.workspace_code }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">
                                            {{ item.workspace.industry_type }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <i class="fas fa-globe text-gray-400 mr-2"></i>
                                            <span class="text-sm text-gray-900">{{ item.workspace.country }}</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <i class="fas fa-envelope text-gray-400 mr-2"></i>
                                            <span class="text-sm text-gray-900">{{ item.workspace.company_email or 'N/A' }}</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <i class="fas fa-phone text-gray-400 mr-2"></i>
                                            <span class="text-sm text-gray-900">{{ item.workspace.company_phone or 'N/A' }}</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <i class="fas fa-users text-gray-400 mr-2"></i>
                                            <span class="text-sm font-medium text-gray-900">{{ item.user_count }}</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <i class="fas fa-hard-hat text-gray-400 mr-2"></i>
                                            <span class="text-sm font-medium text-gray-900">{{ item.worker_count }}</span>
                                            {% if item.workers_this_month > 0 %}
                                                <span class="ml-2 px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">+{{ item.workers_this_month }} new</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <i class="fas fa-tasks text-gray-400 mr-2"></i>
                                            <span class="text-sm font-medium text-gray-900">{{ item.task_count }}</span>
                                            {% if item.completed_tasks > 0 %}
                                                <span class="ml-2 px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">{{ item.completed_tasks }} done</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <i class="fas fa-calendar text-gray-400 mr-2"></i>
                                            <span class="text-sm font-medium {% if item.tasks_this_month > 0 %}text-green-600{% else %}text-gray-500{% endif %}">
                                                {{ item.tasks_this_month }} tasks
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <i class="fas fa-clock text-gray-400 mr-2"></i>
                                            <span class="text-sm font-medium text-gray-900">{{ item.total_attendance_days }}</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            {% set completion_rate = item.completion_rate %}
                                            {% if completion_rate >= 80 %}
                                                <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">
                                                    {{ "%.1f"|format(completion_rate) }}%
                                                </span>
                                            {% elif completion_rate >= 50 %}
                                                <span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">
                                                    {{ "%.1f"|format(completion_rate) }}%
                                                </span>
                                            {% else %}
                                                <span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">
                                                    {{ "%.1f"|format(completion_rate) }}%
                                                </span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        {% if item.workspace.subscription_status == 'active' %}
                                            <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">
                                                <i class="fas fa-check mr-1"></i>Active
                                            </span>
                                        {% elif item.workspace.subscription_status == 'trial' %}
                                            <span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">
                                                <i class="fas fa-clock mr-1"></i>Trial
                                            </span>
                                        {% else %}
                                            <span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">
                                                <i class="fas fa-exclamation mr-1"></i>{{ item.workspace.subscription_status|title }}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        {% set access_status = item.workspace.access_status or 'active' %}
                                        {% if access_status == 'active' %}
                                            <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">
                                                <i class="fas fa-unlock mr-1"></i>Active
                                            </span>
                                        {% elif access_status == 'paused' %}
                                            <span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">
                                                <i class="fas fa-pause mr-1"></i>Paused
                                            </span>
                                        {% elif access_status == 'suspended' %}
                                            <span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">
                                                <i class="fas fa-ban mr-1"></i>Suspended
                                            </span>
                                        {% else %}
                                            <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">
                                                <i class="fas fa-question mr-1"></i>{{ access_status|title }}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <div class="flex space-x-2">
                                            {% set access_status = item.workspace.subscription_status %}
                                            {% if access_status != 'paused' %}
                                                <button onclick="pauseWorkspace({{ item.workspace.id }}, '{{ item.workspace.name|e }}')"
                                                        class="px-3 py-1 text-xs bg-yellow-100 text-yellow-800 rounded-md hover:bg-yellow-200 transition-colors">
                                                    <i class="fas fa-pause mr-1"></i>Pause
                                                </button>
                                            {% else %}
                                                <button onclick="resumeWorkspace({{ item.workspace.id }}, '{{ item.workspace.name|e }}')"
                                                        class="px-3 py-1 text-xs bg-green-100 text-green-800 rounded-md hover:bg-green-200 transition-colors">
                                                    <i class="fas fa-play mr-1"></i>Resume
                                                </button>
                                            {% endif %}
                                            <button onclick="viewWorkspaceDetails({{ item.workspace.id }})"
                                                    class="px-3 py-1 text-xs bg-blue-100 text-blue-800 rounded-md hover:bg-blue-200 transition-colors">
                                                <i class="fas fa-eye mr-1"></i>Details
                                            </button>
                                            <button onclick="deleteWorkspace({{ item.workspace.id }})"
                                                    class="px-3 py-1 text-xs bg-red-100 text-red-800 rounded-md hover:bg-red-200 transition-colors">
                                                <i class="fas fa-trash mr-1"></i>Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>

                <!-- Alerts Section -->
                {% if expiring_trials %}
                <div class="alert-card">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-yellow-600 mr-3 text-lg"></i>
                        <div>
                            <h4 class="font-semibold text-yellow-800">Expiring Trials</h4>
                            <p class="text-yellow-700 text-sm">
                                {{ expiring_trials|length }} workspace(s) have trials expiring soon. 
                                <a href="#" class="underline">Review them</a>
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Advanced Business Intelligence Section -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-chart-bar mr-2 text-pink-500"></i>
                            Business Intelligence & Marketing Analytics
                        </h3>
                        <div class="text-sm text-gray-500">Strategic insights for business growth</div>
                    </div>

                    <!-- Enhanced Marketing Metrics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-4 text-white">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-green-100 text-sm">Active Subscriptions</p>
                                    <p class="text-2xl font-bold">{{ marketing_data.conversion_metrics.paid_workspaces }}</p>
                                </div>
                                <i class="fas fa-credit-card text-green-200 text-xl"></i>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-4 text-white">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-purple-100 text-sm">Trial Workspaces</p>
                                    <p class="text-2xl font-bold">{{ marketing_data.conversion_metrics.trial_workspaces }}</p>
                                </div>
                                <i class="fas fa-clock text-purple-200 text-xl"></i>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-lg p-4 text-white">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-orange-100 text-sm">Active Users (30d)</p>
                                    <p class="text-2xl font-bold">{{ marketing_data.active_users_30d }}</p>
                                </div>
                                <i class="fas fa-users text-orange-200 text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Top Performing Workspaces by Category -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- Top by Tasks -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="text-md font-semibold text-gray-900 mb-3">
                                <i class="fas fa-tasks mr-2 text-blue-500"></i>
                                Top by Task Volume
                            </h4>
                            <div class="space-y-2">
                                {% for item in top_workspaces_by_tasks[:5] %}
                                <div class="flex justify-between items-center bg-white rounded p-2">
                                    <div>
                                        <div class="font-medium text-gray-900 text-sm truncate">{{ item.workspace.name }}</div>
                                        <div class="text-xs text-gray-500">{{ item.workspace.country }}  {{ item.workspace.industry_type }}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-semibold text-blue-600">{{ item.task_count }}</div>
                                        <div class="text-xs text-gray-500">tasks</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Top by Workers -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="text-md font-semibold text-gray-900 mb-3">
                                <i class="fas fa-hard-hat mr-2 text-green-500"></i>
                                Top by Worker Count
                            </h4>
                            <div class="space-y-2">
                                {% for item in top_workspaces_by_workers[:5] %}
                                <div class="flex justify-between items-center bg-white rounded p-2">
                                    <div>
                                        <div class="font-medium text-gray-900 text-sm truncate">{{ item.workspace.name }}</div>
                                        <div class="text-xs text-gray-500">{{ item.workspace.country }}  {{ item.workspace.industry_type }}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-semibold text-green-600">{{ item.worker_count }}</div>
                                        <div class="text-xs text-gray-500">workers</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Top by Activity -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="text-md font-semibold text-gray-900 mb-3">
                                <i class="fas fa-fire mr-2 text-red-500"></i>
                                Most Active Overall
                            </h4>
                            <div class="space-y-2">
                                {% for item in top_workspaces_by_activity[:5] %}
                                <div class="flex justify-between items-center bg-white rounded p-2">
                                    <div>
                                        <div class="font-medium text-gray-900 text-sm truncate">{{ item.workspace.name }}</div>
                                        <div class="text-xs text-gray-500">{{ item.workspace.country }}  {{ item.workspace.industry_type }}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-semibold text-red-600">{{ item.activity_score }}</div>
                                        <div class="text-xs text-gray-500">score</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Industry Performance & Market Opportunities -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">


                        <!-- Market Opportunities -->
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-200">
                            <h4 class="text-md font-semibold text-gray-900 mb-3">
                                <i class="fas fa-globe-americas mr-2 text-blue-600"></i>
                                Market Opportunities
                            </h4>
                            <div class="space-y-3">
                                {% for market in marketing_data.market_opportunities %}
                                <div class="flex justify-between items-center bg-white rounded p-3 shadow-sm">
                                    <div>
                                        <span class="font-medium text-gray-900">{{ market.country }}</span>
                                        <div class="text-xs text-gray-500">
                                            {{ market.workspace_count }} active workspaces
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-semibold text-blue-600">{{ market.workspace_count }}</div>
                                        <div class="text-xs text-gray-500">businesses</div>
                                    </div>
                                </div>
                                {% endfor %}
                                {% if not marketing_data.market_opportunities %}
                                <div class="text-center text-gray-500 py-4">
                                    <i class="fas fa-globe text-2xl text-gray-300 mb-2"></i>
                                    <div class="text-sm">No market data available</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Growth Trend Chart -->
                    <div class="mt-6 bg-gray-50 rounded-lg p-4">
                        <h4 class="text-md font-semibold text-gray-900 mb-3">
                            <i class="fas fa-chart-area mr-2 text-purple-500"></i>
                            Growth & Conversion Trend (Last 6 Months)
                        </h4>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="growthTrendChart"></canvas>
                        </div>
                    </div>

                    <!-- Marketing Insights & Recommendations -->
                    <div class="mt-6 bg-blue-50 rounded-lg p-4 border border-blue-200">
                        <h4 class="text-md font-semibold text-gray-900 mb-3">
                            <i class="fas fa-lightbulb mr-2 text-blue-600"></i>
                            Business Insights & Recommendations
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white rounded p-3 border">
                                <h5 class="font-medium text-gray-900 mb-2"> Focus Markets</h5>
                                <p class="text-sm text-gray-600">
                                    {% if marketing_data.market_opportunities %}
                                    Focus on <strong>{{ marketing_data.market_opportunities[0].country }}</strong> with
                                    {{ marketing_data.market_opportunities[0].workspace_count }} active workspaces showing strong growth.
                                    {% else %}
                                    All markets are performing well. Consider expanding to new regions for growth opportunities.
                                    {% endif %}
                                </p>
                            </div>
                            <div class="bg-white rounded p-3 border">
                                <h5 class="font-medium text-gray-900 mb-2"> Platform Growth</h5>
                                <p class="text-sm text-gray-600">
                                    Platform has <strong>{{ total_workspaces }}</strong> workspaces across
                                    <strong>{{ country_stats|length }}</strong> countries. Continue building features that enhance user engagement.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Task Analytics Section -->
                <div id="task-analytics" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover fade-in">
                    <div class="section-header">
                        <h3 class="text-xl font-bold text-gray-900 mb-2">
                            <i class="fas fa-tasks mr-3 text-purple-600"></i>
                            Task Analytics & Worker Engagement
                        </h3>
                        <p class="text-gray-600">Comprehensive task performance metrics and worker allocation insights</p>
                    </div>

                    <!-- Task Metrics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="metric-card primary rounded-xl p-6 text-center">
                            <div class="metric-value">{{ top_tasks_by_workers|length }}</div>
                            <div class="metric-label">Active Tasks</div>
                            <div class="metric-change positive">
                                <i class="fas fa-arrow-up mr-1"></i>
                                Track worker allocation
                            </div>
                        </div>
                        <div class="metric-card success rounded-xl p-6 text-center">
                            <div class="metric-value">{{ completed_tasks_with_workers|length }}</div>
                            <div class="metric-label">Completed Tasks</div>
                            <div class="metric-change positive">
                                <i class="fas fa-check-circle mr-1"></i>
                                With worker data
                            </div>
                        </div>
                        <div class="metric-card warning rounded-xl p-6 text-center">
                            <div class="metric-value">
                                {% if top_tasks_by_workers %}
                                    {{ top_tasks_by_workers[0].unique_workers }}
                                {% else %}
                                    0
                                {% endif %}
                            </div>
                            <div class="metric-label">Max Workers/Task</div>
                            <div class="metric-change positive">
                                <i class="fas fa-users mr-1"></i>
                                Highest engagement
                            </div>
                        </div>
                        <div class="metric-card danger rounded-xl p-6 text-center">
                            <div class="metric-value">
                                {% if monthly_task_trends %}
                                    {{ "%.1f"|format(monthly_task_trends[-1].avg_workers_per_task) }}
                                {% else %}
                                    0.0
                                {% endif %}
                            </div>
                            <div class="metric-label">Avg Workers/Task</div>
                            <div class="metric-change">
                                <i class="fas fa-chart-line mr-1"></i>
                                Current month
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions for Task Management -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-bolt mr-2 text-yellow-500"></i>
                            Quick Task Insights
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="quick-action text-center" onclick="showTaskDetails('high-engagement')">
                                <i class="fas fa-fire text-2xl text-red-500 mb-2"></i>
                                <div class="font-medium text-white">High Engagement Tasks</div>
                                <div class="text-sm text-gray-300">{{ (top_tasks_by_workers[:5])|length }} tasks with 5+ workers</div>
                            </div>
                            <div class="quick-action text-center" onclick="showTaskDetails('payment-analysis')">
                                <i class="fas fa-dollar-sign text-2xl text-green-500 mb-2"></i>
                                <div class="font-medium text-white">Payment Analysis</div>
                                <div class="text-sm text-gray-300">{{ payment_type_analytics|length }} payment types tracked</div>
                            </div>
                            <div class="quick-action text-center" onclick="showTaskDetails('efficiency')">
                                <i class="fas fa-chart-bar text-2xl text-blue-500 mb-2"></i>
                                <div class="font-medium text-white">Efficiency Metrics</div>
                                <div class="text-sm text-gray-300">Performance scoring available</div>
                            </div>
                        </div>
                    </div>

                    <!-- Top Tasks with Most Workers -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-crown mr-2 text-yellow-500"></i>
                            Tasks with Most Workers
                        </h4>
                        <div class="table-container">
                            <div class="overflow-x-auto">
                                <table class="w-full min-w-max">
                                    <thead class="table-header">
                                        <tr>
                                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-0 w-64">Task Details</th>
                                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-0 w-32">Workers</th>
                                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-0 w-40">Attendance</th>
                                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-0 w-36">Performance</th>
                                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-0 w-28">Priority</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        {% for task in top_tasks_by_workers[:10] %}
                                        <tr class="table-row">
                                            <td class="px-6 py-4">
                                                <div class="flex flex-col">
                                                    <div class="text-sm font-medium text-gray-900">{{ task.task_name }}</div>
                                                    <div class="text-xs text-gray-500">
                                                        <i class="fas fa-building mr-1"></i>{{ task.company_name }}
                                                    </div>
                                                    <div class="text-xs text-gray-400">
                                                        <i class="fas fa-briefcase mr-1"></i>{{ task.workspace_name }}
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="flex items-center">
                                                    <div class="flex-shrink-0">
                                                        <div class="text-lg font-bold text-blue-600">{{ task.unique_workers }}</div>
                                                        <div class="text-xs text-gray-500">unique workers</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="text-sm text-gray-900">{{ task.total_attendance }} days</div>
                                                <div class="text-xs text-gray-500">
                                                    Avg: {{ "%.1f"|format(task.avg_units_completed) }} units
                                                </div>
                                                <div class="progress-bar mt-2">
                                                    <div class="progress-fill" style="width: {{ (task.total_attendance / 30 * 100)|int }}%"></div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="text-sm font-medium text-gray-900">{{ task.efficiency_score }}%</div>
                                                <div class="text-xs text-gray-500">efficiency score</div>
                                                {% if task.status == 'Completed' %}
                                                <span class="inline-flex px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full mt-1">
                                                    <i class="fas fa-check-circle mr-1"></i>{{ task.status }}
                                                </span>
                                                {% else %}
                                                <span class="inline-flex px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full mt-1">
                                                    <i class="fas fa-play-circle mr-1"></i>{{ task.status }}
                                                </span>
                                                {% endif %}
                                            </td>
                                            <td class="px-6 py-4">
                                                <span class="task-priority {{ task.priority }}">
                                                    {% if task.priority == 'high' %}
                                                        <i class="fas fa-fire mr-1"></i>High
                                                    {% elif task.priority == 'medium' %}
                                                        <i class="fas fa-exclamation-triangle mr-1"></i>Medium
                                                    {% else %}
                                                        <i class="fas fa-info-circle mr-1"></i>Low
                                                    {% endif %}
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% if not top_tasks_by_workers %}
                                        <tr>
                                            <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                                <i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i>
                                                <div>No task data available with worker information</div>
                                                <div class="text-sm">Create tasks and add workers to see analytics</div>
                                            </td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Type Analytics -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-credit-card mr-2 text-green-500"></i>
                            Payment Type & Worker Distribution
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {% for payment_type, data in payment_type_analytics.items() %}
                            <div class="insight-card">
                                <h5 class="font-semibold text-gray-900 mb-3">{{ payment_type|title }}</h5>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-600">Tasks:</span>
                                        <span class="font-medium">{{ data.count }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-600">Total Workers:</span>
                                        <span class="font-medium">{{ data.total_workers }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-600">Avg Workers/Task:</span>
                                        <span class="font-medium text-blue-600">{{ data.avg_workers }}</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: {{ (data.avg_workers / 10 * 100)|int }}%"></div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% if not payment_type_analytics %}
                            <div class="insight-card col-span-full text-center">
                                <i class="fas fa-chart-pie text-4xl text-gray-300 mb-4"></i>
                                <div class="text-gray-500">No payment type data available</div>
                                <div class="text-sm text-gray-400">Configure payment types for tasks to see analytics</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Monthly Task Engagement Trend -->
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-chart-line mr-2 text-purple-500"></i>
                            Monthly Task & Worker Engagement Trends
                        </h4>
                        <div class="chart-container">
                            <canvas id="taskEngagementChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- User Role Summary -->
                <div id="reports" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-user-tag mr-2 text-indigo-500"></i>
                        User Role Distribution
                    </h3>
                    <div class="chart-container">
                        <canvas id="roleChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl p-6 max-w-md w-full">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center mr-4">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Confirm Deletion</h3>
                        <p class="text-gray-600 text-sm">This action cannot be undone.</p>
                    </div>
                </div>
                <p id="confirmMessage" class="text-gray-700 mb-6"></p>
                <div class="flex space-x-3">
                    <button onclick="hideConfirmModal()" 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button id="confirmButton" 
                            class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Toggle export dropdown
        function toggleExportDropdown() {
            const dropdown = document.getElementById('exportDropdown');
            dropdown.classList.toggle('hidden');
        }

        // Search functionality
        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const tableRows = document.querySelectorAll('.table-row');
            
            tableRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Time period change for charts
        function changeTimePeriod(period) {
            const btn7d = document.getElementById('btn7d');
            const btn30d = document.getElementById('btn30d');
            
            if (period === '7d') {
                btn7d.className = 'px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-lg';
                btn30d.className = 'px-3 py-1 text-sm bg-gray-100 text-gray-600 rounded-lg';
            } else {
                btn7d.className = 'px-3 py-1 text-sm bg-gray-100 text-gray-600 rounded-lg';
                btn30d.className = 'px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-lg';
            }
            
            // Here you could reload chart data based on the selected period
            console.log('Changed time period to:', period);
        }

        // Scroll to section
        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('exportDropdown');
            const exportButton = event.target.closest('button[onclick="toggleExportDropdown()"]');
            const dropdownContent = event.target.closest('#exportDropdown');
            
            if (!exportButton && !dropdownContent) {
                dropdown.classList.add('hidden');
            }
        });

        // Confirmation modal functions
        function showConfirmModal(message, action) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmButton').onclick = action;
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function hideConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
        }

        // Delete functions
        // Alert notification function
        function showAlert(type, message) {
            // Remove any existing alerts
            const existingAlert = document.querySelector('.custom-alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // Create new alert
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show custom-alert`;
            alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Custom confirmation modal
        function showCustomConfirm(title, message) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.style.display = 'block';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                
                modal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${title}</h5>
                            </div>
                            <div class="modal-body">
                                <p>${message}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                                <button type="button" class="btn btn-primary confirm-btn">Confirm</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                const cancelBtn = modal.querySelector('.cancel-btn');
                const confirmBtn = modal.querySelector('.confirm-btn');
                
                cancelBtn.addEventListener('click', () => {
                    modal.remove();
                    resolve(false);
                });
                
                confirmBtn.addEventListener('click', () => {
                    modal.remove();
                    resolve(true);
                });
                
                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(false);
                    }
                });
            });
        }
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Enhanced workspace action functions
        async function pauseWorkspace(workspaceId, workspaceName) {
            const confirmed = await showCustomConfirm('Pause Workspace', `Are you sure you want to pause "${workspaceName}"? Users will lose access until resumed.`);
            if (!confirmed) {
                return;
            }
            
            fetch(`/admin/pause-workspace/${workspaceId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('success', data.message);
                        // Update the workspace status in the table
                        updateWorkspaceStatus(workspaceId, 'paused');
                        // Refresh the page to update counters
                        setTimeout(() => window.location.reload(), 1500);
                } else {
                    showAlert('error', data.error || 'Failed to pause workspace');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('error', 'Network error occurred');
            });
        }        async function resumeWorkspace(workspaceId, workspaceName) {
            const confirmed = await showCustomConfirm('Resume Workspace', `Are you sure you want to resume "${workspaceName}"?`);
            if (!confirmed) {
                return;
            }
            
            fetch(`/admin/resume-workspace/${workspaceId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('success', data.message);
                        // Update the workspace status in the table
                        updateWorkspaceStatus(workspaceId, data.status);
                        // Refresh the page to update counters
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        showAlert('error', data.error || 'Failed to resume workspace');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('error', 'Network error occurred');
                });
        }

        function updateWorkspaceStatus(workspaceId, newStatus) {
            // Find the workspace row and update the status badge
            const rows = document.querySelectorAll(`#workspacesTable tbody tr`);
            rows.forEach(row => {
                const firstCell = row.cells[0];
                if (firstCell && firstCell.textContent.trim() == workspaceId) {
                    const statusCell = row.cells[3]; // Assuming status is in 4th column
                    if (statusCell) {
                        // Update status badge
                        const badge = statusCell.querySelector('.badge');
                        if (badge) {
                            badge.className = 'badge ' + getStatusBadgeClass(newStatus);
                            badge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                        }
                    }
                    
                    // Update action buttons
                    const actionCell = row.cells[7]; // Assuming actions are in last column
                    if (actionCell) {
                        const actionsDiv = actionCell.querySelector('.workspace-actions');
                        if (actionsDiv) {
                            updateActionButtons(actionsDiv, workspaceId, newStatus);
                        }
                    }
                }
            });
        }

        function getStatusBadgeClass(status) {
            switch (status) {
                case 'active': return 'badge-success';
                case 'trial': return 'badge-info';
                case 'paused': return 'badge-warning';
                case 'expired': return 'badge-danger';
                default: return 'badge-secondary';
            }
        }

        function updateActionButtons(actionsDiv, workspaceId, status) {
            // Clear existing buttons
            actionsDiv.innerHTML = '';
            
            // Create appropriate buttons based on status
            if (status === 'paused') {
                actionsDiv.innerHTML = `
                    <button class="btn btn-sm btn-success me-1" onclick="resumeWorkspace(${workspaceId}, 'Workspace')" title="Resume Workspace">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteWorkspace(${workspaceId})" title="Delete Workspace">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
            } else {
                actionsDiv.innerHTML = `
                    <button class="btn btn-sm btn-warning me-1" onclick="pauseWorkspace(${workspaceId}, 'Workspace')" title="Pause Workspace">
                        <i class="fas fa-pause"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteWorkspace(${workspaceId})" title="Delete Workspace">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
            }
        }

        function deleteWorkspace(workspaceId) {
            showConfirmModal(
                `Are you sure you want to delete this workspace? This will remove all associated data including workers, tasks, and attendance records.`,
                () => {
                    fetch(`/admin/delete-workspace/${workspaceId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            showAlert('error', 'Error deleting workspace: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('error', 'Error deleting workspace');
                    });
                    hideConfirmModal();
                }
            );
        }

        function deleteWorker(workerId) {
            showConfirmModal(
                `Are you sure you want to delete this worker? This will remove all associated attendance records.`,
                () => {
                    fetch(`/admin/delete-worker/${workerId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            showAlert('error', 'Error deleting worker: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('error', 'Error deleting worker');
                    });
                    hideConfirmModal();
                }
            );
        }

        function deleteUser(userId) {
            showConfirmModal(
                `Are you sure you want to delete this user? This will remove all associated data.`,
                () => {
                    fetch(`/admin/delete-user/${userId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            showAlert('error', 'Error deleting user: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('error', 'Error deleting user');
                    });
                    hideConfirmModal();
                }
            );
        }

        // Charts
        document.addEventListener('DOMContentLoaded', function() {
            // Industry Chart
            const industryCtx = document.getElementById('industryChart').getContext('2d');
            new Chart(industryCtx, {
                type: 'doughnut',
                data: {
                    labels: [{% for industry, count in industry_stats %}'{{ industry }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                    datasets: [{
                        data: [{% for industry, count in industry_stats %}{{ count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                        backgroundColor: [
                            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                            '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });

            // Country Chart
            const countryCtx = document.getElementById('countryChart').getContext('2d');
            new Chart(countryCtx, {
                type: 'bar',
                data: {
                    labels: [{% for country, count in country_stats %}'{{ country }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                    datasets: [{
                        label: 'Workspaces',
                        data: [{% for country, count in country_stats %}{{ count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                        backgroundColor: '#10b981',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#f3f4f6'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // User Growth Chart - Dynamic Implementation
            let userGrowthChart;
            const userGrowthCtx = document.getElementById('userGrowthChart').getContext('2d');
            
            function initUserGrowthChart(period = '30d') {
                // Destroy existing chart if it exists
                if (userGrowthChart) {
                    userGrowthChart.destroy();
                }
                
                // Fetch data for the specified period
                fetch(`/admin/user-growth-data/${period}`)
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            const data = result.data;
                            userGrowthChart = new Chart(userGrowthCtx, {
                                type: 'line',
                                data: {
                                    labels: data.map(item => item.label),
                                    datasets: [{
                                        label: 'New Users',
                                        data: data.map(item => item.count),
                                        borderColor: '#8b5cf6',
                                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                        tension: 0.4,
                                        fill: true
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            display: false
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            grid: {
                                                color: '#f3f4f6'
                                            }
                                        },
                                        x: {
                                            grid: {
                                                display: false
                                            }
                                        }
                                    }
                                }
                            });
                        } else {
                            console.error('Error loading chart data:', result.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching chart data:', error);
                    });
            }
            
            // Function to switch time periods
            function switchUserGrowthPeriod(period) {
                // Update active button state
                document.querySelectorAll('.time-period-btn').forEach(btn => {
                    btn.classList.remove('active', 'bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-100', 'text-gray-700');
                });
                
                const activeBtn = document.querySelector(`[onclick="switchUserGrowthPeriod('${period}')"]`);
                if (activeBtn) {
                    activeBtn.classList.remove('bg-gray-100', 'text-gray-700');
                    activeBtn.classList.add('active', 'bg-blue-600', 'text-white');
                }
                
                // Reload chart with new period
                initUserGrowthChart(period);
            }
            
            // Initialize chart with default period (30 days)
            initUserGrowthChart('30d');

            // Role Chart
            const roleCtx = document.getElementById('roleChart').getContext('2d');
            new Chart(roleCtx, {
                type: 'pie',
                data: {
                    labels: [{% for role, count in role_stats %}'{{ role }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                    datasets: [{
                        data: [{% for role, count in role_stats %}{{ count }}{% if not loop.last %}, {% endif %}{% endfor %}],
                        backgroundColor: [
                            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });

            // Growth Trend Chart for Business Intelligence
            const growthTrendCtx = document.getElementById('growthTrendChart').getContext('2d');
            new Chart(growthTrendCtx, {
                type: 'line',
                data: {
                    labels: [{% for data in marketing_data.growth_data %}'{{ data.month }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                    datasets: [{
                        label: 'Signups',
                        data: [{% for data in marketing_data.growth_data %}{{ data.signups }}{% if not loop.last %}, {% endif %}{% endfor %}],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: false,
                        yAxisID: 'y'
                    }, {
                        label: 'Conversions',
                        data: [{% for data in marketing_data.growth_data %}{{ data.conversions }}{% if not loop.last %}, {% endif %}{% endfor %}],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: false,
                        yAxisID: 'y'
                    }, {
                        label: 'Conversion Rate (%)',
                        data: [{% for data in marketing_data.growth_data %}{{ "%.1f"|format(data.conversion_rate) }}{% if not loop.last %}, {% endif %}{% endfor %}],
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        fill: false,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Growth Metrics & Conversion Trends'
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            grid: {
                                color: '#f3f4f6'
                            },
                            title: {
                                display: true,
                                text: 'Count'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: 'Conversion Rate (%)'
                            }
                        }
                    }
                }
            });

            // Task Engagement Chart
            const taskEngagementCtx = document.getElementById('taskEngagementChart').getContext('2d');
            new Chart(taskEngagementCtx, {
                type: 'line',
                data: {
                    labels: [{% for trend in monthly_task_trends %}'{{ trend.month }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                    datasets: [{
                        label: 'Tasks Created',
                        data: [{% for trend in monthly_task_trends %}{{ trend.tasks_created }}{% if not loop.last %}, {% endif %}{% endfor %}],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        yAxisID: 'y'
                    }, {
                        label: 'Worker Engagement',
                        data: [{% for trend in monthly_task_trends %}{{ trend.worker_engagement }}{% if not loop.last %}, {% endif %}{% endfor %}],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true,
                        yAxisID: 'y'
                    }, {
                        label: 'Avg Workers/Task',
                        data: [{% for trend in monthly_task_trends %}{{ trend.avg_workers_per_task }}{% if not loop.last %}, {% endif %}{% endfor %}],
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        fill: false,
                        type: 'line',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Task Creation & Worker Engagement Trends'
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: 'Average Workers per Task'
                            }
                        }
                    }
                }
            });
        });

        // Enhanced Interactive Functions for Better UX
        function showTaskDetails(type) {
            let message = '';
            switch(type) {
                case 'high-engagement':
                    message = 'Tasks with 5+ workers show high employee engagement and potential for scaling.';
                    break;
                case 'payment-analysis':
                    message = 'Payment type analysis helps optimize compensation strategies for better worker attraction.';
                    break;
                case 'efficiency':
                    message = 'Efficiency scores combine attendance consistency with unit completion rates.';
                    break;
            }
            
            // Enhanced notification with better styling
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-white border border-gray-200 rounded-xl p-4 shadow-lg z-50 max-w-sm';
            notification.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-blue-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-gray-900">Task Insight</p>
                        <p class="text-sm text-gray-500 mt-1">${message}</p>
                    </div>
                    <div class="ml-4 flex-shrink-0 flex">
                        <button class="text-gray-400 hover:text-gray-500" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Enhanced search functionality
        function filterTasks(searchTerm) {
            const rows = document.querySelectorAll('#task-analytics tbody tr');
            
            rows.forEach(row => {
                const taskName = row.querySelector('td:first-child .text-sm').textContent.toLowerCase();
                const companyName = row.querySelector('.text-xs').textContent.toLowerCase();
                
                if (taskName.includes(searchTerm.toLowerCase()) || companyName.includes(searchTerm.toLowerCase())) {
                    row.style.display = '';
                    row.classList.add('fade-in');
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Smooth scrolling for navigation
        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                element.scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
                
                // Add highlight effect
                element.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.3)';
                setTimeout(() => {
                    element.style.boxShadow = '';
                }, 2000);
            }
        }

        // Enhanced responsive table handling
        function handleResponsiveTable() {
            const tables = document.querySelectorAll('.table-container table');
            
            tables.forEach(table => {
                if (window.innerWidth < 768) {
                    table.classList.add('text-sm');
                } else {
                    table.classList.remove('text-sm');
                }
            });
        }

        // Initialize responsive handling
        window.addEventListener('resize', handleResponsiveTable);
        handleResponsiveTable();

        // Add floating action button functionality
        document.addEventListener('DOMContentLoaded', function() {
            const fab = document.createElement('div');
            fab.className = 'fab';
            fab.innerHTML = '<i class="fas fa-plus"></i>';
            fab.onclick = function() {
                scrollToSection('task-analytics');
            };
            document.body.appendChild(fab);
        });

        // Enhanced Dashboard Functions
        function exportDashboardData() {
            // Create a notification
            showNotification('Exporting dashboard data...', 'info');
            
            // Simulate export process
            setTimeout(() => {
                showNotification('Dashboard data exported successfully!', 'success');
            }, 2000);
        }

        function refreshDashboard() {
            showNotification('Refreshing dashboard data...', 'info');
            
            // Add loading overlay
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            overlay.innerHTML = `
                <div class="bg-white rounded-xl p-8 text-center">
                    <div class="loading mb-4"></div>
                    <p class="text-gray-600">Refreshing dashboard data...</p>
                </div>
            `;
            document.body.appendChild(overlay);
            
            // Simulate refresh
            setTimeout(() => {
                overlay.remove();
                location.reload();
            }, 2000);
        }

        function showNotification(message, type = 'info') {
            const icons = {
                'info': 'fas fa-info-circle text-blue-500',
                'success': 'fas fa-check-circle text-green-500',
                'warning': 'fas fa-exclamation-triangle text-yellow-500',
                'error': 'fas fa-times-circle text-red-500'
            };
            
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-white border border-gray-200 rounded-xl p-4 shadow-lg z-50 max-w-sm animate-fade-in';
            notification.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="${icons[type]}"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-gray-900">${message}</p>
                    </div>
                    <div class="ml-4 flex-shrink-0 flex">
                        <button class="text-gray-400 hover:text-gray-500" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // Enhanced search functionality for all sections
        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (searchTerm === '') {
                // Clear all filters
                resetAllFilters();
                return;
            }
            
            // Search in workspaces
            filterWorkspaces(searchTerm);
            
            // Search in tasks
            filterTasks(searchTerm);
            
            // Search in users
            filterUsers(searchTerm);
        }

        function resetAllFilters() {
            // Reset workspace filters
            const workspaceRows = document.querySelectorAll('#workspace-analytics tbody tr');
            workspaceRows.forEach(row => {
                row.style.display = '';
            });
            
            // Reset task filters
            const taskRows = document.querySelectorAll('#task-analytics tbody tr');
            taskRows.forEach(row => {
                row.style.display = '';
            });
            
            // Reset user filters
            const userRows = document.querySelectorAll('#reports tbody tr');
            userRows.forEach(row => {
                row.style.display = '';
            });
        }

        function filterWorkspaces(searchTerm) {
            const rows = document.querySelectorAll('#workspace-analytics tbody tr');
            
            rows.forEach(row => {
                const workspaceName = row.querySelector('td:first-child .text-sm')?.textContent.toLowerCase() || '';
                const industry = row.querySelector('.text-xs')?.textContent.toLowerCase() || '';
                
                if (workspaceName.includes(searchTerm) || industry.includes(searchTerm)) {
                    row.style.display = '';
                    row.classList.add('fade-in');
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function filterUsers(searchTerm) {
            const rows = document.querySelectorAll('#reports tbody tr');
            
            rows.forEach(row => {
                const userName = row.querySelector('td:first-child .font-medium')?.textContent.toLowerCase() || '';
                const email = row.querySelector('.text-gray-500')?.textContent.toLowerCase() || '';
                
                if (userName.includes(searchTerm) || email.includes(searchTerm)) {
                    row.style.display = '';
                    row.classList.add('fade-in');
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Add section IDs for navigation
        document.addEventListener('DOMContentLoaded', function() {
            // Add IDs to sections for navigation
            const sections = [
                {id: 'overview', selector: '.grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-6.gap-6'},
                {id: 'workspace-analytics', selector: 'h3:contains("Enhanced Workspace Analytics")'},
                {id: 'task-analytics', selector: '#task-analytics'},
                {id: 'reports', selector: '#reports'}
            ];
            
            sections.forEach(section => {
                const element = document.querySelector(section.selector);
                if (element && !element.id) {
                    element.id = section.id;
                }
            });
        });
    </script>
</body>
</html> 