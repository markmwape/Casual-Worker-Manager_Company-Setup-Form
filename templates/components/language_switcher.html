<!-- Language Switcher Component -->
<div class="language-switcher-container">
    <div class="dropdown dropdown-end">
        <button type="button" class="btn btn-sm gap-2 language-switcher-btn language-toggle">
            <span class="text-xl">üåê</span>
            <span class="current-lang-label font-semibold text-sm">English</span>
            <svg class="w-4 h-4 transition-transform dropdown-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </button>
        <ul class="dropdown-content z-[300] menu p-2 shadow-xl bg-white border border-gray-200 rounded-lg w-56 mt-2 language-menu" style="display: none;">
            <!-- Populated by JavaScript -->
        </ul>
    </div>
</div>

<style>
    .language-switcher-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .language-switcher-container .dropdown {
        position: relative;
    }
    
    /* Modern button styling */
    .language-switcher-btn {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 2px solid #e2e8f0;
        color: #1e293b;
        padding: 0.5rem 1rem;
        border-radius: 0.75rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
        font-weight: 600;
        cursor: pointer;
    }
    
    .language-switcher-btn:hover {
        background: linear-gradient(135deg, #f8f9fa 0%, #f1f5f9 100%);
        border-color: #cbd5e1;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12), 0 2px 4px rgba(0, 0, 0, 0.08);
        transform: translateY(-1px);
    }
    
    .language-switcher-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    
    /* Dropdown arrow animation */
    .dropdown-arrow {
        transition: transform 0.2s ease;
    }
    
    .dropdown.dropdown-open .dropdown-arrow {
        transform: rotate(180deg);
    }
    
    /* Button focus state */
    .language-switcher-btn:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
    }
    
    /* Dropdown menu styling */
    .language-switcher-container .dropdown-content {
        max-height: 400px;
        overflow-y: auto;
        animation: slideDown 0.2s ease-out;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Menu item styling */
    .language-switcher-container .dropdown-content li a {
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        transition: all 0.15s ease;
        font-weight: 500;
        color: #475569;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .language-switcher-container .dropdown-content li a:hover {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        transform: translateX(4px);
    }
    
    .language-switcher-container .dropdown-content li a.active {
        background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
        color: white;
        font-weight: 700;
    }
    
    /* Make dropdown open upward only in sidebar */
    .sidebar-language-switcher .dropdown {
        position: relative;
    }
    
    .sidebar-language-switcher .language-menu {
        bottom: 100%;
        top: auto !important;
        margin-bottom: 0.5rem;
        margin-top: 0;
        animation: slideUp 0.2s ease-out;
        z-index: 400;
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Make dropdown open upward in mobile menu footer */
    .mobile-menu-language-switcher .dropdown {
        position: relative;
    }
    
    .mobile-menu-language-switcher .language-menu {
        bottom: 100%;
        top: auto !important;
        margin-bottom: 0.5rem;
        margin-top: 0;
        animation: slideUp 0.2s ease-out;
        z-index: 500;
    }
    
    /* Fix mobile menu dropdown positioning */
    .mobile-menu-language-switcher {
        position: relative;
        z-index: 100;
    }
    
    /* Ensure dropdowns are visible above everything */
    .language-menu {
        position: absolute;
        z-index: 300;
    }
    
    /* Fix dropdown on mobile screens */
    @media (max-width: 768px) {
        .language-menu {
            position: fixed !important;
            right: 1rem;
            left: auto;
            width: calc(100vw - 2rem);
            max-width: 280px;
            z-index: 1000;
        }
        
        .mobile-menu-language-switcher .language-menu {
            position: absolute !important;
            bottom: 100%;
            right: 0;
            left: auto;
            width: 200px;
            z-index: 1000;
        }
    }
    
    @media (max-width: 768px) {
        .language-switcher-container {
            margin: 0.5rem 0;
            width: 100%;
        }
        
        .language-switcher-btn {
            width: 100%;
            justify-content: space-between;
            padding: 0.75rem 1rem;
        }
        
        /* Ensure mobile dropdowns work properly */
        .dropdown:focus-within .dropdown-content,
        .dropdown:hover .dropdown-content,
        .dropdown.dropdown-open .dropdown-content {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
    }
    
    /* Fix for DaisyUI dropdown behavior */
    .dropdown:focus-within .dropdown-content,
    .dropdown-content:focus-within {
        display: block;
        opacity: 1;
        visibility: visible;
    }
    
    /* Improve dropdown accessibility */
    .language-toggle:focus + .language-menu,
    .language-menu:focus-within {
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
    }
    
    /* Better click handling */
    .language-switcher-btn:active,
    .language-switcher-btn:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
    }
</style>

<script>
    // Initialize language switcher - handles multiple instances
    function initLanguageSwitcher() {
        try {
            console.log('Initializing language switcher...');
            
            // Fetch available languages
            fetch('/api/languages')
                .then(response => {
                    console.log('Languages response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Languages data received:', data);
                    const languages = data.languages || {};
                    const currentLanguage = data.current_language || 'en';
                    
                    // Update all language menus (handle multiple instances)
                    const languageMenus = document.querySelectorAll('.language-menu');
                    languageMenus.forEach((languageMenu, index) => {
                        if (languageMenu) {
                            languageMenu.innerHTML = ''; // Clear existing items
                            let itemCount = 0;
                            for (const [code, name] of Object.entries(languages)) {
                                const li = document.createElement('li');
                                const a = document.createElement('a');
                                a.textContent = name;
                                a.href = 'javascript:void(0)';
                                a.setAttribute('data-lang', code);
                                a.style.cursor = 'pointer';
                                
                                // Add click handler
                                a.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    const lang = this.getAttribute('data-lang');
                                    console.log('Language clicked:', lang, '(' + name + ')');
                                    changeLanguage(lang);
                                    
                                    // Close all dropdowns
                                    document.querySelectorAll('.dropdown').forEach(dropdown => {
                                        if (dropdown.querySelector('input[type="checkbox"]')) {
                                            dropdown.querySelector('input[type="checkbox"]').checked = false;
                                        }
                                        dropdown.blur();
                                    });
                                });
                                
                                if (code === currentLanguage) {
                                    a.classList.add('active', 'font-bold');
                                }
                                
                                li.appendChild(a);
                                languageMenu.appendChild(li);
                                itemCount++;
                            }
                            console.log(`Language menu ${index + 1} populated with`, itemCount, 'languages');
                        }
                    });
                    
                    // Update all current language labels
                    const currentLangLabels = document.querySelectorAll('.current-lang-label');
                    currentLangLabels.forEach((label, index) => {
                        if (label && languages[currentLanguage]) {
                            label.textContent = languages[currentLanguage];
                            console.log(`Current language label ${index + 1} updated to:`, languages[currentLanguage]);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading languages:', error);
                    // Fallback: show default languages
                    const defaultLanguages = {
                        'en': 'English',
                        'fr': 'Fran√ßais', 
                        'es': 'Espa√±ol',
                        'pt': 'Portugu√™s',
                        'sw': 'Swahili'
                    };
                    
                    const languageMenus = document.querySelectorAll('.language-menu');
                    languageMenus.forEach((languageMenu) => {
                        if (languageMenu && languageMenu.children.length === 0) {
                            for (const [code, name] of Object.entries(defaultLanguages)) {
                                const li = document.createElement('li');
                                const a = document.createElement('a');
                                a.textContent = name;
                                a.href = 'javascript:void(0)';
                                a.setAttribute('data-lang', code);
                                a.style.cursor = 'pointer';
                                a.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    const lang = this.getAttribute('data-lang');
                                    changeLanguage(lang);
                                });
                                li.appendChild(a);
                                languageMenu.appendChild(li);
                            }
                        }
                    });
                });
        } catch (error) {
            console.error('Error initializing language switcher:', error);
        }
    }
    
    // Change language function
    function changeLanguage(langCode) {
        console.log('Changing language to:', langCode);
        
        // Show loading state
        const currentLangLabels = document.querySelectorAll('.current-lang-label');
        currentLangLabels.forEach(label => {
            label.textContent = 'Changing...';
        });
        
        try {
            fetch('/api/change-language', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ language: langCode })
            })
            .then(response => {
                console.log('Change language response status:', response.status);
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    console.log('Language changed successfully, updating page...');
                    
                    // Update labels immediately
                    const languageNames = {
                        'en': 'English',
                        'fr': 'Fran√ßais',
                        'sw': 'Swahili', 
                        'pt': 'Portugu√™s',
                        'es': 'Espa√±ol',
                        'tr': 'T√ºrk√ße',
                        'hi': '‡§π‡§ø‡§Ç‡§¶‡•Ä',
                        'zh': '‰∏≠Êñá',
                        'ar': 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©',
                        'vi': 'Ti·∫øng Vi·ªát'
                    };
                    
                    currentLangLabels.forEach(label => {
                        label.textContent = languageNames[langCode] || langCode.toUpperCase();
                    });
                    
                    // Update active states
                    document.querySelectorAll('.language-menu a').forEach(link => {
                        link.classList.remove('active', 'font-bold');
                        if (link.getAttribute('data-lang') === langCode) {
                            link.classList.add('active', 'font-bold');
                        }
                    });
                    
                    // Update the page using i18n system or reload
                    if (window.i18n && typeof window.i18n.setLanguage === 'function') {
                        console.log('Using i18n.setLanguage to update page');
                        window.i18n.setLanguage(langCode);
                    } else {
                        console.log('i18n system not available, reloading page after delay');
                        setTimeout(() => {
                            window.location.reload();
                        }, 500);
                    }
                } else {
                    console.error('Error response from change-language endpoint:', result);
                    currentLangLabels.forEach(label => {
                        label.textContent = 'Error';
                    });
                    setTimeout(() => {
                        initLanguageSwitcher(); // Reset
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error changing language:', error);
                currentLangLabels.forEach(label => {
                    label.textContent = 'Error';
                });
                setTimeout(() => {
                    initLanguageSwitcher(); // Reset
                }, 2000);
            });
        } catch (error) {
            console.error('Error in changeLanguage function:', error);
            currentLangLabels.forEach(label => {
                label.textContent = 'Error';
            });
        }
    }    // Make changeLanguage globally available
    window.changeLanguage = changeLanguage;
    
    // Add dropdown behavior handlers
    function setupDropdownBehavior() {
        console.log('Setting up dropdown behavior...');
        
        // Handle dropdown toggle behavior with improved button handling
        document.querySelectorAll('.language-toggle').forEach((toggle, index) => {
            console.log(`Setting up click handler for toggle ${index + 1}`);
            
            // Ensure button is clickable
            toggle.style.pointerEvents = 'auto';
            toggle.style.cursor = 'pointer';
            
            // Remove any existing event listeners by cloning the element
            const newToggle = toggle.cloneNode(true);
            toggle.parentNode.replaceChild(newToggle, toggle);
            
            newToggle.addEventListener('click', function(e) {
                console.log(`Language switcher button ${index + 1} clicked!`);
                e.preventDefault();
                e.stopPropagation();
                
                const dropdown = this.closest('.dropdown');
                const menu = dropdown.querySelector('.language-menu');
                
                if (!dropdown || !menu) {
                    console.error('Error: Could not find dropdown or menu elements');
                    return;
                }
                
                // Close other dropdowns first
                document.querySelectorAll('.dropdown').forEach(otherDropdown => {
                    if (otherDropdown !== dropdown) {
                        const otherMenu = otherDropdown.querySelector('.language-menu');
                        if (otherMenu) {
                            otherMenu.style.display = 'none';
                            otherDropdown.classList.remove('dropdown-open');
                        }
                    }
                });
                
                // Toggle current dropdown
                const isVisible = menu.style.display === 'block';
                if (isVisible) {
                    menu.style.display = 'none';
                    dropdown.classList.remove('dropdown-open');
                    console.log(`Dropdown ${index + 1} closed`);
                } else {
                    menu.style.display = 'block';
                    dropdown.classList.add('dropdown-open');
                    console.log(`Dropdown ${index + 1} opened`);
                    
                    // Position the menu properly
                    const rect = this.getBoundingClientRect();
                    const menuRect = menu.getBoundingClientRect();
                    
                    // Adjust positioning if menu would go off-screen
                    if (rect.bottom + menuRect.height > window.innerHeight) {
                        menu.style.bottom = '100%';
                        menu.style.top = 'auto';
                        menu.style.marginBottom = '0.5rem';
                        menu.style.marginTop = '0';
                    } else {
                        menu.style.top = '100%';
                        menu.style.bottom = 'auto';
                        menu.style.marginTop = '0.5rem';
                        menu.style.marginBottom = '0';
                    }
                }
            });
            
            // Add keyboard support
            newToggle.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    console.log(`Language switcher keyboard activated: ${e.key}`);
                    this.click();
                }
            });
        });
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.language-switcher-container')) {
                document.querySelectorAll('.language-menu').forEach(menu => {
                    menu.style.display = 'none';
                });
                document.querySelectorAll('.dropdown').forEach(dropdown => {
                    dropdown.classList.remove('dropdown-open');
                });
            }
        });
        
        // Handle escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.language-menu').forEach(menu => {
                    menu.style.display = 'none';
                });
                document.querySelectorAll('.dropdown').forEach(dropdown => {
                    dropdown.classList.remove('dropdown-open');
                });
            }
        });
        
        console.log('Dropdown behavior setup completed');
    }
    
    // Initialize everything
    function initLanguageSwitcherComplete() {
        initLanguageSwitcher();
        setupDropdownBehavior();
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLanguageSwitcherComplete);
    } else {
        // DOM already loaded
        initLanguageSwitcherComplete();
    }
    
    // Re-initialize when new language switchers are added dynamically
    window.reinitLanguageSwitcher = initLanguageSwitcherComplete;
</script>
