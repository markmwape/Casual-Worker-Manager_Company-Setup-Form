<!-- Language Switcher Component -->
<div class="language-switcher-container">
    <div class="dropdown dropdown-end">
        <button class="btn btn-sm btn-ghost gap-2" id="languageToggle">
            <span class="text-lg">üåê</span>
            <span id="currentLangLabel">English</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
            </svg>
        </button>
        <ul class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52" id="languageMenu">
            <!-- Populated by JavaScript -->
        </ul>
    </div>
</div>

<style>
    .language-switcher-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    @media (max-width: 768px) {
        .language-switcher-container {
            margin: 0.5rem 0;
        }
    }
</style>

<script>
    // Initialize language switcher
    function initLanguageSwitcher() {
        try {
            console.log('Initializing language switcher...');
            
            // Fetch available languages
            fetch('/api/languages')
                .then(response => {
                    console.log('Languages response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Languages data received:', data);
                    const languages = data.languages || {};
                    const currentLanguage = data.current_language || 'en';
                    
                    // Populate language menu
                    const languageMenu = document.getElementById('languageMenu');
                    if (languageMenu) {
                        languageMenu.innerHTML = ''; // Clear existing items
                        for (const [code, name] of Object.entries(languages)) {
                            const li = document.createElement('li');
                            const a = document.createElement('a');
                            a.textContent = name;
                            a.href = '#';
                            a.onclick = (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                console.log('Language clicked:', code);
                                changeLanguage(code);
                                return false;
                            };
                            
                            if (code === currentLanguage) {
                                a.classList.add('active');
                            }
                            
                            li.appendChild(a);
                            languageMenu.appendChild(li);
                        }
                        console.log('Language menu populated with', Object.keys(languages).length, 'languages');
                    } else {
                        console.error('Language menu element not found');
                    }
                    
                    // Update current language label
                    const currentLangLabel = document.getElementById('currentLangLabel');
                    if (currentLangLabel && languages[currentLanguage]) {
                        currentLangLabel.textContent = languages[currentLanguage];
                        console.log('Current language label updated to:', languages[currentLanguage]);
                    }
                })
                .catch(error => {
                    console.error('Error loading languages:', error);
                });
        } catch (error) {
            console.error('Error initializing language switcher:', error);
        }
    }
    
    // Change language function
    function changeLanguage(langCode) {
        console.log('Changing language to:', langCode);
        try {
            fetch('/api/change-language', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ language: langCode })
            })
            .then(response => {
                console.log('Change language response status:', response.status);
                if (response.ok) {
                    console.log('Language changed successfully, reloading page...');
                    // Reload page to apply new language
                    window.location.reload();
                } else {
                    console.error('Error response from change-language endpoint');
                    alert('Error changing language');
                }
            })
            .catch(error => {
                console.error('Error changing language:', error);
                alert('Error changing language');
            });
        } catch (error) {
            console.error('Error in changeLanguage function:', error);
            alert('Error changing language');
        }
    }
    
    // Make changeLanguage globally available
    window.changeLanguage = changeLanguage;
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLanguageSwitcher);
    } else {
        // DOM already loaded
        initLanguageSwitcher();
    }
</script>
