<!-- Language Switcher Component -->
<div class="language-switcher-container">
    <div class="dropdown dropdown-end">
        <label tabindex="0" class="btn btn-sm gap-2 language-switcher-btn" id="languageToggle">
            <span class="text-xl">üåê</span>
            <span id="currentLangLabel" class="font-semibold text-sm">English</span>
            <svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </label>
        <ul tabindex="0" class="dropdown-content z-[200] menu p-2 shadow-xl bg-white border border-gray-200 rounded-lg w-56 mt-2" id="languageMenu">
            <!-- Populated by JavaScript -->
        </ul>
    </div>
</div>

<style>
    .language-switcher-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .language-switcher-container .dropdown {
        position: relative;
    }
    
    /* Modern button styling */
    .language-switcher-btn {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 2px solid #e2e8f0;
        color: #1e293b;
        padding: 0.5rem 1rem;
        border-radius: 0.75rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
        font-weight: 600;
        cursor: pointer;
    }
    
    .language-switcher-btn:hover {
        background: linear-gradient(135deg, #f8f9fa 0%, #f1f5f9 100%);
        border-color: #cbd5e1;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12), 0 2px 4px rgba(0, 0, 0, 0.08);
        transform: translateY(-1px);
    }
    
    .language-switcher-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    
    /* Dropdown menu styling */
    .language-switcher-container .dropdown-content {
        max-height: 400px;
        overflow-y: auto;
        animation: slideDown 0.2s ease-out;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Menu item styling */
    .language-switcher-container .dropdown-content li a {
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        transition: all 0.15s ease;
        font-weight: 500;
        color: #475569;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .language-switcher-container .dropdown-content li a:hover {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        transform: translateX(4px);
    }
    
    .language-switcher-container .dropdown-content li a.active {
        background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
        color: white;
        font-weight: 700;
    }
    
    /* Make dropdown open upward only in sidebar */
    .sidebar-language-switcher .dropdown {
        position: relative;
    }
    
    .sidebar-language-switcher .dropdown-content {
        bottom: 100%;
        top: auto !important;
        margin-bottom: 0.5rem;
        margin-top: 0;
        animation: slideUp 0.2s ease-out;
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Make dropdown open upward in mobile menu footer */
    .mobile-menu-language-switcher .dropdown {
        position: relative;
    }
    
    .mobile-menu-language-switcher .dropdown-content {
        bottom: 100%;
        top: auto !important;
        margin-bottom: 0.5rem;
        margin-top: 0;
        animation: slideUp 0.2s ease-out;
    }
    
    @media (max-width: 768px) {
        .language-switcher-container {
            margin: 0.5rem 0;
            width: 100%;
        }
        
        .language-switcher-btn {
            width: 100%;
            justify-content: space-between;
            padding: 0.75rem 1rem;
        }
    }
</style>

<script>
    // Initialize language switcher
    function initLanguageSwitcher() {
        try {
            console.log('Initializing language switcher...');
            
            // Fetch available languages
            fetch('/api/languages')
                .then(response => {
                    console.log('Languages response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Languages data received:', data);
                    const languages = data.languages || {};
                    const currentLanguage = data.current_language || 'en';
                    
                    // Populate language menu
                    const languageMenu = document.getElementById('languageMenu');
                    if (languageMenu) {
                        languageMenu.innerHTML = ''; // Clear existing items
                        let itemCount = 0;
                        for (const [code, name] of Object.entries(languages)) {
                            const li = document.createElement('li');
                            const a = document.createElement('a');
                            a.textContent = name;
                            a.href = 'javascript:void(0)';
                            a.setAttribute('data-lang', code);
                            a.style.cursor = 'pointer';
                            
                            // Add click handler
                            a.addEventListener('click', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                const lang = this.getAttribute('data-lang');
                                console.log('Language clicked:', lang, '(' + name + ')');
                                changeLanguage(lang);
                            });
                            
                            if (code === currentLanguage) {
                                a.classList.add('active', 'font-bold');
                            }
                            
                            li.appendChild(a);
                            languageMenu.appendChild(li);
                            itemCount++;
                        }
                        console.log('Language menu populated with', itemCount, 'languages');
                        
                        // Test that menu is visible
                        setTimeout(() => {
                            const menuRect = languageMenu.getBoundingClientRect();
                            console.log('Language menu position:', menuRect);
                        }, 100);
                    } else {
                        console.error('Language menu element not found');
                    }
                    
                    // Update current language label
                    const currentLangLabel = document.getElementById('currentLangLabel');
                    if (currentLangLabel && languages[currentLanguage]) {
                        currentLangLabel.textContent = languages[currentLanguage];
                        console.log('Current language label updated to:', languages[currentLanguage]);
                    }
                })
                .catch(error => {
                    console.error('Error loading languages:', error);
                });
        } catch (error) {
            console.error('Error initializing language switcher:', error);
        }
    }
    
    // Change language function
    function changeLanguage(langCode) {
        console.log('Changing language to:', langCode);
        try {
            fetch('/api/change-language', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ language: langCode })
            })
            .then(response => {
                console.log('Change language response status:', response.status);
                if (response.ok) {
                    console.log('Language changed successfully, updating page...');
                    // Update the page using i18n system instead of full reload
                    if (window.i18n && typeof window.i18n.setLanguage === 'function') {
                        console.log('Using i18n.setLanguage to update page');
                        window.i18n.setLanguage(langCode);
                    } else {
                        console.log('i18n system not available, reloading page');
                        window.location.reload();
                    }
                } else {
                    console.error('Error response from change-language endpoint');
                    alert('Error changing language');
                }
            })
            .catch(error => {
                console.error('Error changing language:', error);
                alert('Error changing language');
            });
        } catch (error) {
            console.error('Error in changeLanguage function:', error);
            alert('Error changing language');
        }
    }    // Make changeLanguage globally available
    window.changeLanguage = changeLanguage;
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLanguageSwitcher);
    } else {
        // DOM already loaded
        initLanguageSwitcher();
    }
</script>
