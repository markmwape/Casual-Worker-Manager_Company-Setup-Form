<!-- Language Switcher Component -->
<div class="language-switcher-container">
    <div class="dropdown dropdown-end dropdown-top">
        <label tabindex="0" class="btn btn-sm btn-ghost gap-2" id="languageToggle">
            <span class="text-lg">üåê</span>
            <span id="currentLangLabel">English</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </label>
        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52 mb-2" id="languageMenu">
            <!-- Populated by JavaScript -->
        </ul>
    </div>
</div>

<style>
    .language-switcher-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    @media (max-width: 768px) {
        .language-switcher-container {
            margin: 0.5rem 0;
        }
    }
</style>

<script>
    // Initialize language switcher
    function initLanguageSwitcher() {
        try {
            console.log('Initializing language switcher...');
            
            // Fetch available languages
            fetch('/api/languages')
                .then(response => {
                    console.log('Languages response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Languages data received:', data);
                    const languages = data.languages || {};
                    const currentLanguage = data.current_language || 'en';
                    
                    // Populate language menu
                    const languageMenu = document.getElementById('languageMenu');
                    if (languageMenu) {
                        languageMenu.innerHTML = ''; // Clear existing items
                        let itemCount = 0;
                        for (const [code, name] of Object.entries(languages)) {
                            const li = document.createElement('li');
                            const a = document.createElement('a');
                            a.textContent = name;
                            a.href = 'javascript:void(0)';
                            a.setAttribute('data-lang', code);
                            a.style.cursor = 'pointer';
                            
                            // Add click handler
                            a.addEventListener('click', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                const lang = this.getAttribute('data-lang');
                                console.log('Language clicked:', lang, '(' + name + ')');
                                changeLanguage(lang);
                            });
                            
                            if (code === currentLanguage) {
                                a.classList.add('active', 'font-bold');
                            }
                            
                            li.appendChild(a);
                            languageMenu.appendChild(li);
                            itemCount++;
                        }
                        console.log('Language menu populated with', itemCount, 'languages');
                        
                        // Test that menu is visible
                        setTimeout(() => {
                            const menuRect = languageMenu.getBoundingClientRect();
                            console.log('Language menu position:', menuRect);
                        }, 100);
                    } else {
                        console.error('Language menu element not found');
                    }
                    
                    // Update current language label
                    const currentLangLabel = document.getElementById('currentLangLabel');
                    if (currentLangLabel && languages[currentLanguage]) {
                        currentLangLabel.textContent = languages[currentLanguage];
                        console.log('Current language label updated to:', languages[currentLanguage]);
                    }
                })
                .catch(error => {
                    console.error('Error loading languages:', error);
                });
        } catch (error) {
            console.error('Error initializing language switcher:', error);
        }
    }
    
    // Change language function
    function changeLanguage(langCode) {
        console.log('Changing language to:', langCode);
        try {
            fetch('/api/change-language', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ language: langCode })
            })
            .then(response => {
                console.log('Change language response status:', response.status);
                if (response.ok) {
                    console.log('Language changed successfully, updating page...');
                    // Update the page using i18n system instead of full reload
                    if (window.i18n && typeof window.i18n.setLanguage === 'function') {
                        console.log('Using i18n.setLanguage to update page');
                        window.i18n.setLanguage(langCode);
                    } else {
                        console.log('i18n system not available, reloading page');
                        window.location.reload();
                    }
                } else {
                    console.error('Error response from change-language endpoint');
                    alert('Error changing language');
                }
            })
            .catch(error => {
                console.error('Error changing language:', error);
                alert('Error changing language');
            });
        } catch (error) {
            console.error('Error in changeLanguage function:', error);
            alert('Error changing language');
        }
    }    // Make changeLanguage globally available
    window.changeLanguage = changeLanguage;
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLanguageSwitcher);
    } else {
        // DOM already loaded
        initLanguageSwitcher();
    }
</script>
