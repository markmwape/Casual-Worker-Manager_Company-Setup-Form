<!-- Enhanced Language Switcher Component -->
<div class="language-switcher-container">
    <div class="dropdown dropdown-end">
        <button type="button" 
                tabindex="0" 
                class="language-switcher-btn btn btn-sm gap-2 px-3 py-2 bg-white/90 hover:bg-white border border-gray-200 hover:border-gray-300 text-gray-700 hover:text-gray-900 shadow-sm hover:shadow-md transition-all duration-200 rounded-lg backdrop-blur-sm"
                aria-label="Select Language"
                role="button">
            <!-- Globe Icon -->
            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9m0 9c-1.657 0-3-1.343-3-3s1.343-3 3-3m0 6c1.657 0 3-1.343 3-3s-1.343-3 3-3"></path>
            </svg>
            
            <!-- Current Language Display -->
            <span class="current-lang-display font-medium text-sm min-w-[60px] text-center">
                <span class="current-lang-label">English</span>
            </span>
            
            <!-- Dropdown Arrow with Animation -->
            <svg class="w-3 h-3 transition-transform duration-200 dropdown-arrow text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </button>
        
        <!-- Enhanced Dropdown Menu -->
        <ul tabindex="0" 
            class="dropdown-content menu p-1 shadow-xl bg-white border border-gray-200 rounded-lg w-48 mt-1 language-menu opacity-0 invisible transition-all duration-200"
            role="menu"
            aria-label="Language options">
            <!-- Menu items populated by JavaScript -->
        </ul>
    </div>
</div>

<style>
    /* Enhanced Language Switcher Styles */
    .language-switcher-container {
        position: relative;
        z-index: 50;
    }
    
    .language-switcher-container .dropdown {
        position: relative;
        overflow: visible !important;
    }
    
    /* Button Enhancements */
    .language-switcher-btn {
        position: relative;
        min-height: 36px;
        font-weight: 500;
        cursor: pointer;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }
    
    .language-switcher-btn:hover {
        transform: translateY(-1px);
    }
    
    .language-switcher-btn:active {
        transform: translateY(0);
    }
    
    /* Focus States */
    .language-switcher-btn:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5), 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    /* Arrow Animation */
    .dropdown.dropdown-open .dropdown-arrow {
        transform: rotate(180deg);
    }
    
    /* Enhanced Dropdown Menu */
    .language-menu {
        position: absolute !important;
        z-index: 1000 !important;
        background: white !important;
        border: 1px solid #e5e7eb !important;
        border-radius: 8px !important;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        padding: 4px 0 !important;
        min-width: 180px !important;
        max-width: 240px !important;
        backdrop-filter: blur(8px);
        animation: slideDownFade 0.15s ease-out forwards;
    }
    
    /* Menu Item Styling */
    .language-menu li {
        display: block !important;
        list-style: none !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .language-menu li a {
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        padding: 10px 16px !important;
        color: #374151 !important;
        text-decoration: none !important;
        cursor: pointer !important;
        transition: all 0.15s ease !important;
        border-radius: 6px !important;
        margin: 2px 4px !important;
        font-size: 14px !important;
        font-weight: 500 !important;
        position: relative;
    }
    
    .language-menu li a:hover {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%) !important;
        color: #111827 !important;
        transform: translateX(2px) !important;
    }
    
    .language-menu li a:active {
        background: #e5e7eb !important;
        transform: translateX(0) !important;
    }
    
    /* Active Language Indicator */
    .language-menu li a.active {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
        color: white !important;
        font-weight: 600 !important;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2) !important;
    }
    
    .language-menu li a.active::after {
        content: '✓';
        position: absolute;
        right: 12px;
        color: white;
        font-weight: bold;
        font-size: 12px;
    }
    
    /* Loading State */
    .language-switcher-btn.loading {
        opacity: 0.7;
        pointer-events: none;
    }
    
    .language-switcher-btn.loading .current-lang-display::after {
        content: '';
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 50%;
        border-top-color: #3b82f6;
        animation: spin 1s linear infinite;
        margin-left: 8px;
    }
    
    /* Animations */
    @keyframes slideDownFade {
        from {
            opacity: 0;
            transform: translateY(-8px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    
    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
    
    /* Context-Specific Adjustments */
    
    /* Sidebar Context */
    .sidebar-language-switcher .language-switcher-btn {
        background: rgba(255, 255, 255, 0.1) !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        color: white !important;
        backdrop-filter: blur(4px);
    }
    
    .sidebar-language-switcher .language-switcher-btn:hover {
        background: rgba(255, 255, 255, 0.2) !important;
        border-color: rgba(255, 255, 255, 0.3) !important;
    }
    
    .sidebar-language-switcher .language-menu {
        bottom: calc(100% + 8px) !important;
        top: auto !important;
        right: 0 !important;
        left: auto !important;
        animation: slideUpFade 0.15s ease-out forwards;
    }
    
    .sidebar-language-switcher svg {
        color: rgba(255, 255, 255, 0.8) !important;
    }
    
    .sidebar-language-switcher .current-lang-display {
        color: white !important;
    }
    
    /* Mobile Menu Context */
    .mobile-menu-language-switcher .language-switcher-btn {
        width: 100% !important;
        justify-content: center !important;
        padding: 12px 16px !important;
        background: #f9fafb !important;
        border: 1px solid #e5e7eb !important;
        color: #374151 !important;
    }
    
    .mobile-menu-language-switcher .language-menu {
        bottom: calc(100% + 8px) !important;
        top: auto !important;
        right: 0 !important;
        left: auto !important;
        width: 100% !important;
        max-width: 280px !important;
        animation: slideUpFade 0.15s ease-out forwards;
    }
    
    /* Landing Page Context */
    .landing-language-switcher .language-switcher-btn {
        background: rgba(255, 255, 255, 0.95) !important;
        border: 1px solid rgba(255, 255, 255, 0.8) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
        backdrop-filter: blur(12px);
    }
    
    /* DaisyUI Integration */
    .dropdown:focus-within .dropdown-content,
    .dropdown-content:focus-within {
        opacity: 1 !important;
        visibility: visible !important;
        pointer-events: auto !important;
    }
    
    /* Accessibility Improvements */
    .language-switcher-btn[aria-expanded="true"] .dropdown-arrow {
        transform: rotate(180deg);
    }
    
    /* High Contrast Mode Support */
    @media (prefers-contrast: high) {
        .language-switcher-btn {
            border: 2px solid currentColor !important;
        }
        
        .language-menu {
            border: 2px solid currentColor !important;
        }
    }
    
    /* Reduced Motion Support */
    @media (prefers-reduced-motion: reduce) {
        .language-switcher-btn,
        .language-menu li a,
        .dropdown-arrow {
            transition: none !important;
        }
        
        .language-menu {
            animation: none !important;
        }
    }
    
    /* Mobile Optimizations */
    @media (max-width: 768px) {
        .language-menu {
            position: fixed !important;
            right: 16px !important;
            left: auto !important;
            width: calc(100vw - 32px) !important;
            max-width: 280px !important;
            z-index: 1000 !important;
        }
        
        .language-switcher-btn {
            min-height: 44px; /* iOS touch target */
        }
    }
    
    /* Dark Mode Support (if needed) */
    @media (prefers-color-scheme: dark) {
        .language-menu {
            background: #1f2937 !important;
            border-color: #374151 !important;
        }
        
        .language-menu li a {
            color: #e5e7eb !important;
        }
        
        .language-menu li a:hover {
            background: #374151 !important;
            color: #f9fafb !important;
        }
    }
</style>

<script>
    // Enhanced Language Switcher with Better UX
    function initLanguageSwitcher() {
        try {
            console.log('Initializing enhanced language switcher...');
            
            // Fetch available languages with error handling
            fetch('/api/languages')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    console.log('Languages response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Languages data received:', data);
                    const languages = data.languages || {};
                    const currentLanguage = data.current_language || 'en';
                    
                    // Update all language menus with enhanced UI
                    const languageMenus = document.querySelectorAll('.language-menu');
                    languageMenus.forEach((languageMenu, index) => {
                        if (languageMenu) {
                            languageMenu.innerHTML = ''; // Clear existing items
                            let itemCount = 0;
                            
                            // Sort languages alphabetically for better UX
                            const sortedLanguages = Object.entries(languages).sort((a, b) => a[1].localeCompare(b[1]));
                            
                            for (const [code, name] of sortedLanguages) {
                                const li = document.createElement('li');
                                li.style.display = 'block';
                                li.style.listStyle = 'none';
                                li.style.margin = '0';
                                li.style.padding = '0';
                                
                                const a = document.createElement('a');
                                a.textContent = name;
                                a.href = 'javascript:void(0)';
                                a.setAttribute('data-lang', code);
                                a.setAttribute('role', 'menuitem');
                                a.setAttribute('tabindex', '-1');
                                
                                // Enhanced styling
                                a.style.display = 'flex';
                                a.style.alignItems = 'center';
                                a.style.justifyContent = 'space-between';
                                a.style.padding = '10px 16px';
                                a.style.color = '#374151';
                                a.style.cursor = 'pointer';
                                a.style.borderRadius = '6px';
                                a.style.transition = 'all 0.15s ease';
                                a.style.textDecoration = 'none';
                                a.style.margin = '2px 4px';
                                a.style.fontSize = '14px';
                                a.style.fontWeight = '500';
                                a.style.position = 'relative';
                                
                                // Add language code for additional context
                                const langCode = document.createElement('span');
                                langCode.textContent = code.toUpperCase();
                                langCode.style.fontSize = '11px';
                                langCode.style.fontWeight = '600';
                                langCode.style.color = 'rgba(107, 114, 128, 0.8)';
                                langCode.style.marginLeft = '8px';
                                a.appendChild(langCode);
                                
                                // Enhanced click handler with better feedback
                                a.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    const lang = this.getAttribute('data-lang');
                                    console.log('Language clicked:', lang, '(' + name + ')');
                                    
                                    // Provide immediate visual feedback
                                    this.style.background = '#dbeafe';
                                    this.style.color = '#1e40af';
                                    
                                    // Close all dropdowns immediately
                                    document.querySelectorAll('.language-menu').forEach(menu => {
                                        menu.classList.remove('opacity-100', 'visible');
                                        menu.classList.add('opacity-0', 'invisible');
                                    });
                                    document.querySelectorAll('.dropdown').forEach(dropdown => {
                                        dropdown.classList.remove('dropdown-open');
                                    });
                                    
                                    // Update button state
                                    document.querySelectorAll('.language-switcher-btn').forEach(btn => {
                                        btn.classList.add('loading');
                                        btn.setAttribute('aria-expanded', 'false');
                                    });
                                    
                                    changeLanguage(lang);
                                });
                                
                                // Enhanced hover effects
                                a.addEventListener('mouseenter', function() {
                                    if (!this.classList.contains('active')) {
                                        this.style.background = 'linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%)';
                                        this.style.color = '#111827';
                                        this.style.transform = 'translateX(2px)';
                                    }
                                });
                                
                                a.addEventListener('mouseleave', function() {
                                    if (!this.classList.contains('active')) {
                                        this.style.background = 'transparent';
                                        this.style.color = '#374151';
                                        this.style.transform = 'translateX(0)';
                                    }
                                });
                                
                                // Active state styling
                                if (code === currentLanguage) {
                                    a.classList.add('active');
                                    a.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
                                    a.style.color = 'white';
                                    a.style.fontWeight = '600';
                                    a.style.boxShadow = '0 2px 4px rgba(59, 130, 246, 0.2)';
                                    
                                    // Add checkmark
                                    const checkmark = document.createElement('span');
                                    checkmark.textContent = '✓';
                                    checkmark.style.position = 'absolute';
                                    checkmark.style.right = '12px';
                                    checkmark.style.color = 'white';
                                    checkmark.style.fontWeight = 'bold';
                                    checkmark.style.fontSize = '12px';
                                    a.appendChild(checkmark);
                                }
                                
                                li.appendChild(a);
                                languageMenu.appendChild(li);
                                itemCount++;
                            }
                            console.log(`Language menu ${index + 1} populated with`, itemCount, 'languages');
                        }
                    });
                    
                    // Update all current language labels
                    const currentLangLabels = document.querySelectorAll('.current-lang-label');
                    currentLangLabels.forEach((label, index) => {
                        if (label && languages[currentLanguage]) {
                            label.textContent = languages[currentLanguage];
                            console.log(`Current language label ${index + 1} updated to:`, languages[currentLanguage]);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading languages:', error);
                    
                    // Enhanced fallback with better error handling
                    const fallbackLanguages = {
                        'en': 'English',
                        'fr': 'Français', 
                        'sw': 'Swahili',
                        'pt': 'Português',
                        'es': 'Español',
                        'tr': 'Türkçe',
                        'hi': 'हिंदी',
                        'zh': '中文',
                        'ar': 'العربية',
                        'vi': 'Tiếng Việt'
                    };
                    
                    const languageMenus = document.querySelectorAll('.language-menu');
                    languageMenus.forEach((languageMenu) => {
                        if (languageMenu && languageMenu.children.length === 0) {
                            const sortedLanguages = Object.entries(fallbackLanguages).sort((a, b) => a[1].localeCompare(b[1]));
                            
                            for (const [code, name] of sortedLanguages) {
                                const li = document.createElement('li');
                                const a = document.createElement('a');
                                a.textContent = name;
                                a.href = 'javascript:void(0)';
                                a.setAttribute('data-lang', code);
                                a.setAttribute('role', 'menuitem');
                                a.setAttribute('tabindex', '-1');
                                
                                // Add language code
                                const langCode = document.createElement('span');
                                langCode.textContent = code.toUpperCase();
                                langCode.style.fontSize = '11px';
                                langCode.style.fontWeight = '600';
                                langCode.style.color = 'rgba(107, 114, 128, 0.8)';
                                langCode.style.marginLeft = '8px';
                                a.appendChild(langCode);
                                
                                a.style.cursor = 'pointer';
                                a.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    const lang = this.getAttribute('data-lang');
                                    
                                    // Visual feedback
                                    this.style.background = '#dbeafe';
                                    
                                    // Close dropdowns
                                    document.querySelectorAll('.language-menu').forEach(menu => {
                                        menu.classList.remove('opacity-100', 'visible');
                                        menu.classList.add('opacity-0', 'invisible');
                                    });
                                    
                                    // Update button state
                                    document.querySelectorAll('.language-switcher-btn').forEach(btn => {
                                        btn.classList.add('loading');
                                    });
                                    
                                    changeLanguage(lang);
                                });
                                li.appendChild(a);
                                languageMenu.appendChild(li);
                            }
                        }
                    });
                    
                    // Show error state briefly
                    const currentLangLabels = document.querySelectorAll('.current-lang-label');
                    currentLangLabels.forEach(label => {
                        label.textContent = '⚠️ Error';
                        setTimeout(() => {
                            label.textContent = 'English';
                        }, 2000);
                    });
                });
        } catch (error) {
            console.error('Error initializing language switcher:', error);
        }
    }
    
    // Enhanced changeLanguage function with better UX
    function changeLanguage(langCode) {
        console.log('Changing language to:', langCode);
        
        // Enhanced loading state
        const buttons = document.querySelectorAll('.language-switcher-btn');
        const currentLabels = document.querySelectorAll('.current-lang-label');
        
        buttons.forEach(btn => {
            btn.classList.add('loading');
            btn.setAttribute('disabled', 'true');
            btn.setAttribute('aria-expanded', 'false');
        });
        
        currentLabels.forEach(label => {
            label.textContent = '⏳';
        });
        
        try {
            fetch('/api/change-language', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ language: langCode })
            })
            .then(response => {
                console.log('Change language response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    console.log('Language changed successfully, updating page...');
                    
                    // Enhanced success feedback
                    const languageNames = {
                        'en': 'English',
                        'fr': 'Français',
                        'sw': 'Swahili', 
                        'pt': 'Português',
                        'es': 'Español',
                        'tr': 'Türkçe',
                        'hi': 'हिंदी',
                        'zh': '中文',
                        'ar': 'العربية',
                        'vi': 'Tiếng Việt'
                    };
                    
                    // Success animation
                    buttons.forEach(btn => {
                        btn.classList.remove('loading');
                        btn.classList.add('success');
                        btn.removeAttribute('disabled');
                        
                        setTimeout(() => {
                            btn.classList.remove('success');
                        }, 1000);
                    });
                    
                    currentLabels.forEach(label => {
                        label.textContent = languageNames[langCode] || langCode.toUpperCase();
                    });
                    
                    // Update active states with animation
                    document.querySelectorAll('.language-menu a').forEach(link => {
                        link.classList.remove('active');
                        link.style.background = 'transparent';
                        link.style.color = '#374151';
                        link.style.fontWeight = '500';
                        
                        if (link.getAttribute('data-lang') === langCode) {
                            link.classList.add('active');
                            link.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
                            link.style.color = 'white';
                            link.style.fontWeight = '600';
                        }
                    });
                    
                    // Page update with better handling
                    if (window.i18n && typeof window.i18n.setLanguage === 'function') {
                        console.log('Using i18n.setLanguage to update page');
                        window.i18n.setLanguage(langCode);
                    } else {
                        console.log('i18n system not available, reloading page after delay');
                        // Show success message before reload
                        currentLabels.forEach(label => {
                            label.textContent = '✅ ' + (languageNames[langCode] || langCode.toUpperCase());
                        });
                        
                        setTimeout(() => {
                            window.location.reload();
                        }, 800);
                    }
                } else {
                    console.error('Error response from change-language endpoint:', result);
                    throw new Error(result.message || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error changing language:', error);
                
                // Enhanced error handling
                buttons.forEach(btn => {
                    btn.classList.remove('loading');
                    btn.classList.add('error');
                    btn.removeAttribute('disabled');
                    
                    setTimeout(() => {
                        btn.classList.remove('error');
                    }, 2000);
                });
                
                currentLabels.forEach(label => {
                    label.textContent = '❌ Error';
                    
                    setTimeout(() => {
                        initLanguageSwitcher(); // Reset
                    }, 2000);
                });
            });
        } catch (error) {
            console.error('Error in changeLanguage function:', error);
            
            // Fallback error state
            buttons.forEach(btn => {
                btn.classList.remove('loading');
                btn.removeAttribute('disabled');
            });
            
            currentLabels.forEach(label => {
                label.textContent = '❌ Error';
            });
        }
    }
    
    // Enhanced dropdown behavior with better accessibility
    function setupDropdownBehavior() {
        console.log('Setting up enhanced dropdown behavior...');
        
        // Enhanced button handling
        document.querySelectorAll('.language-switcher-btn').forEach((button, index) => {
            console.log(`Setting up enhanced button ${index + 1}`);
            
            // Ensure button is accessible
            button.setAttribute('aria-haspopup', 'true');
            button.setAttribute('aria-expanded', 'false');
            
            // Enhanced click handler
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const dropdown = this.closest('.dropdown');
                const menu = dropdown.querySelector('.language-menu');
                const isExpanded = this.getAttribute('aria-expanded') === 'true';
                
                console.log(`Button ${index + 1} clicked, expanded:`, isExpanded);
                
                // Close other dropdowns
                document.querySelectorAll('.dropdown').forEach(otherDropdown => {
                    if (otherDropdown !== dropdown) {
                        const otherButton = otherDropdown.querySelector('.language-switcher-btn');
                        const otherMenu = otherDropdown.querySelector('.language-menu');
                        
                        if (otherButton) otherButton.setAttribute('aria-expanded', 'false');
                        if (otherMenu) {
                            otherMenu.classList.remove('opacity-100', 'visible');
                            otherMenu.classList.add('opacity-0', 'invisible');
                        }
                        otherDropdown.classList.remove('dropdown-open');
                    }
                });
                
                // Toggle current dropdown
                if (isExpanded) {
                    // Close
                    this.setAttribute('aria-expanded', 'false');
                    if (menu) {
                        menu.classList.remove('opacity-100', 'visible');
                        menu.classList.add('opacity-0', 'invisible');
                    }
                    dropdown.classList.remove('dropdown-open');
                    console.log(`Dropdown ${index + 1} closed`);
                } else {
                    // Open
                    this.setAttribute('aria-expanded', 'true');
                    if (menu) {
                        menu.classList.remove('opacity-0', 'invisible');
                        menu.classList.add('opacity-100', 'visible');
                    }
                    dropdown.classList.add('dropdown-open');
                    console.log(`Dropdown ${index + 1} opened`);
                    
                    // Focus management
                    setTimeout(() => {
                        const firstItem = menu.querySelector('a');
                        if (firstItem) firstItem.focus();
                    }, 100);
                }
            });
            
            // Keyboard support
            button.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (this.getAttribute('aria-expanded') !== 'true') {
                        this.click();
                    }
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    this.setAttribute('aria-expanded', 'false');
                    const menu = this.closest('.dropdown').querySelector('.language-menu');
                    if (menu) {
                        menu.classList.remove('opacity-100', 'visible');
                        menu.classList.add('opacity-0', 'invisible');
                    }
                    this.closest('.dropdown').classList.remove('dropdown-open');
                }
            });
        });
        
        // Enhanced menu item keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close all dropdowns
                document.querySelectorAll('.language-switcher-btn').forEach(btn => {
                    btn.setAttribute('aria-expanded', 'false');
                });
                document.querySelectorAll('.language-menu').forEach(menu => {
                    menu.classList.remove('opacity-100', 'visible');
                    menu.classList.add('opacity-0', 'invisible');
                });
                document.querySelectorAll('.dropdown').forEach(dropdown => {
                    dropdown.classList.remove('dropdown-open');
                });
            }
        });
        
        // Click outside to close
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.language-switcher-container')) {
                document.querySelectorAll('.language-switcher-btn').forEach(btn => {
                    btn.setAttribute('aria-expanded', 'false');
                });
                document.querySelectorAll('.language-menu').forEach(menu => {
                    menu.classList.remove('opacity-100', 'visible');
                    menu.classList.add('opacity-0', 'invisible');
                });
                document.querySelectorAll('.dropdown').forEach(dropdown => {
                    dropdown.classList.remove('dropdown-open');
                });
            }
        });
        
        console.log('Enhanced dropdown behavior setup completed');
    }
    
    // Initialize everything with better error handling
    function initLanguageSwitcherComplete() {
        try {
            initLanguageSwitcher();
            setupDropdownBehavior();
            console.log('Language switcher initialization completed successfully');
        } catch (error) {
            console.error('Error during language switcher initialization:', error);
        }
    }
    
    // Make functions globally available
    window.changeLanguage = changeLanguage;
    window.initLanguageSwitcher = initLanguageSwitcherComplete;
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLanguageSwitcherComplete);
    } else {
        // DOM already loaded
        initLanguageSwitcherComplete();
    }
    
    // Re-initialize when new language switchers are added dynamically
    window.reinitLanguageSwitcher = initLanguageSwitcherComplete;
</script>
