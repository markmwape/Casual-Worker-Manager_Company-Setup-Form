<dialog id="add-worker-to-task-modal" class="modal">
    <div class="modal-box max-w-lg">
        <h3 class="font-bold text-lg mb-4">Add Worker to Task</h3>
        <form id="addWorkerToTaskForm" class="space-y-4">
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text font-medium">Search Worker</span>
                </label>
                <div class="relative">
                    <input type="text" 
                           id="workerSearch" 
                           class="input input-bordered w-full pr-10" 
                           placeholder="Type name, ID, or any field to search..."
                           autocomplete="off"
                           required>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                        <i data-feather="search" class="h-4 w-4 text-gray-400"></i>
                    </div>
                    <div id="workersDropdown" class="absolute left-0 right-0 bg-white border border-blue-200 rounded-lg shadow-lg z-[100] mt-1 hidden max-h-48 overflow-y-auto">
                        <div class="p-2 text-sm text-gray-500 border-b border-gray-100">
                            Start typing to see available workers
                        </div>
                    </div>
                    <input type="hidden" id="selectedWorkerId">
                </div>
                <div class="label">
                    <span class="label-text-alt text-gray-500">
                        <i data-feather="info" class="inline h-3 w-3 mr-1"></i>
                        Search by name, date of birth, or any custom field
                    </span>
                </div>
            </div>
            <div class="modal-action mt-6">
                <button type="button" class="btn btn-ghost" onclick="closeAddWorkerToTaskModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addWorkerToTask()">
                    <i data-feather="plus" class="mr-2 h-4 w-4"></i>
                    Add Worker
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button type="button" onclick="closeAddWorkerToTaskModal()">close</button>
    </form>
</dialog>

<script>
    // Prepare all workers data for search (rendered as a JS array)
    const allWorkers = [
        {% for worker in available_workers %}
        {
            id: "{{ worker.id }}",
            name: "{{ worker.first_name }} {{ worker.last_name }}",
            {% if worker.date_of_birth %}date_of_birth: "{{ worker.date_of_birth.strftime('%Y-%m-%d') }}",{% endif %}
            {% for cf in worker.custom_field_values %}
            custom_{{ cf.custom_field_id }}: "{{ cf.value }}",
            {% endfor %}
            all_fields: "{{ worker.first_name }} {{ worker.last_name }}{% if worker.date_of_birth %} {{ worker.date_of_birth.strftime('%Y-%m-%d') }}{% endif %} {% for cf in worker.custom_field_values %} {{ cf.value }}{% endfor %} {{ worker.id }}"
        },
        {% endfor %}
    ];

    function openAddWorkerToTaskModal(taskId) {
        document.getElementById('add-worker-to-task-modal').showModal();
        document.getElementById('addWorkerToTaskForm').dataset.taskId = taskId;
        document.getElementById('workerSearch').value = '';
        document.getElementById('selectedWorkerId').value = '';
        document.getElementById('workersDropdown').classList.add('hidden');
        renderWorkerDropdown('');
    }

    function closeAddWorkerToTaskModal() {
        document.getElementById('add-worker-to-task-modal').close();
    }

    let lastDropdownSelection = false;

    document.getElementById('workerSearch').addEventListener('input', function(e) {
        const searchValue = e.target.value.toLowerCase();
        lastDropdownSelection = false;
        document.getElementById('selectedWorkerId').value = '';
        console.log('Input changed:', searchValue); // Debug log
        renderWorkerDropdown(searchValue);
    });

    let currentDropdownIndex = -1;

    function renderWorkerDropdown(searchValue) {
        const dropdown = document.getElementById('workersDropdown');
        dropdown.innerHTML = '';
        if (!searchValue) {
            dropdown.classList.add('hidden');
            currentDropdownIndex = -1;
            return;
        }
        const matches = allWorkers.filter(worker => worker.all_fields.toLowerCase().includes(searchValue));
        console.log('Rendering dropdown, matches:', matches.map(w => w.name)); // Debug log
        if (matches.length === 0) {
            dropdown.innerHTML = '<div class="px-3 py-2 text-sm text-gray-500 text-center">No workers found</div>';
            currentDropdownIndex = -1;
        } else {
            // Show limited results to reduce scrolling
            const limitedMatches = matches.slice(0, 8);
            limitedMatches.forEach((worker, idx) => {
                const div = document.createElement('div');
                div.className = 'px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition-colors text-sm';
                
                // Create a more informative display
                const displayText = document.createElement('div');
                displayText.className = 'font-medium text-gray-800';
                displayText.textContent = worker.name;
                
                // Add additional info if available
                const subText = document.createElement('div');
                subText.className = 'text-xs text-gray-500 mt-0.5';
                if (worker.date_of_birth) {
                    subText.textContent = `DOB: ${worker.date_of_birth}`;
                }
                
                div.appendChild(displayText);
                if (subText.textContent) {
                    div.appendChild(subText);
                }
                
                div.onclick = function() {
                    const input = document.getElementById('workerSearch');
                    input.value = worker.name;
                    document.getElementById('selectedWorkerId').value = worker.id;
                    dropdown.classList.add('hidden');
                    lastDropdownSelection = true;
                    input.blur();
                    console.log('Selected worker:', worker.name, 'ID:', worker.id); // Debug log
                };
                div.setAttribute('data-index', idx);
                dropdown.appendChild(div);
            });
            
            // Show "more results" indicator if there are more
            if (matches.length > 8) {
                const moreDiv = document.createElement('div');
                moreDiv.className = 'px-3 py-2 text-xs text-center text-gray-500 bg-gray-50';
                moreDiv.textContent = `+ ${matches.length - 8} more results - keep typing to refine`;
                dropdown.appendChild(moreDiv);
            }
            
            currentDropdownIndex = -1;
        }
        dropdown.classList.remove('hidden');
    }

    document.getElementById('workerSearch').addEventListener('blur', function() {
        setTimeout(() => {
            document.getElementById('workersDropdown').classList.add('hidden');
        }, 200);
    });

    document.getElementById('workerSearch').addEventListener('keydown', function(e) {
        const dropdown = document.getElementById('workersDropdown');
        const items = dropdown.querySelectorAll('div[data-index]');
        if (!items.length || dropdown.classList.contains('hidden')) return;
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            currentDropdownIndex = (currentDropdownIndex + 1) % items.length;
            items.forEach((item, idx) => {
                item.classList.toggle('bg-blue-100', idx === currentDropdownIndex);
            });
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            currentDropdownIndex = (currentDropdownIndex - 1 + items.length) % items.length;
            items.forEach((item, idx) => {
                item.classList.toggle('bg-blue-100', idx === currentDropdownIndex);
            });
        } else if (e.key === 'Enter') {
            if (currentDropdownIndex >= 0 && currentDropdownIndex < items.length) {
                items[currentDropdownIndex].click();
            }
        }
    });

    function addWorkerToTask() {
        const taskId = document.getElementById('addWorkerToTaskForm').dataset.taskId;
        const workerId = document.getElementById('selectedWorkerId').value;
        const workerName = document.getElementById('workerSearch').value;

        if (!workerId || !lastDropdownSelection) {
            showCustomModal('Validation Error', 'Please select a valid worker from the list', 'warning');
            return;
        }

        fetch(`/api/task/${taskId}/add-worker`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                worker_id: workerId
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                showCustomModal('Error', result.error, 'error');
            } else {
                showCustomModal('Success', 'Worker added to task successfully', 'success');
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error adding worker to task:', error);
            showCustomModal('Error', 'Failed to add worker to task', 'error');
        });
    }
</script>