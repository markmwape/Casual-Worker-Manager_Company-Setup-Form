{% extends "base.html" %}

{% block content %}
<!-- Error Modal -->
<div id="reportErrorModal" class="fixed inset-0 flex items-center justify-center z-50 error-modal-bg" style="display:none;">
  <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full relative border-t-8 border-red-200 animate-fade-in">
    <button onclick="closeReportErrorModal()" class="absolute top-3 right-4 text-gray-400 hover:text-gray-700 text-3xl font-bold">&times;</button>
    <div class="flex items-center mb-4">
      <div class="bg-red-100 rounded-full p-2 mr-3 flex items-center justify-center"><i data-feather="alert-circle" class="w-7 h-7 text-red-500"></i></div>
      <h3 class="text-xl font-semibold text-red-700">Report Error</h3>
    </div>
    <div id="reportErrorMessage" class="text-gray-800 leading-relaxed"></div>
    <div class="mt-6 text-right">
      <button onclick="closeReportErrorModal()" class="btn px-5 py-2 font-semibold rounded-lg shadow-sm" style="background: linear-gradient(90deg, #fca5a5 0%, #fecaca 100%); color: #b91c1c;">OK</button>
    </div>
  </div>
</div>

<div class="container mx-auto px-4 w-full max-w-6xl pt-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-black">Reports</h1>
    </div>

    <div class="card date-range-card mb-6">
        <div class="card-body">
            <div class="flex items-center mb-6">
                <div class="bg-blue-100 p-3 rounded-full mr-4 shadow-sm">
                    <i data-feather="calendar" class="w-6 h-6 text-blue-600"></i>
                </div>
                <div>
                    <h2 class="card-title text-blue-800 mb-1">Report Date Range</h2>
                    <p class="text-sm text-blue-600">Select the date range for your report generation</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold text-blue-700 flex items-center">
                            <i data-feather="play" class="w-4 h-4 mr-2"></i>
                            Start Date
                        </span>
                    </label>
                    <div class="relative">
                        <input type="date" id="startDate" class="date-input-enhanced w-full" onchange="updateReportPreview()" placeholder="Select start date">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <i data-feather="calendar" class="w-4 h-4 text-blue-400"></i>
                        </div>
                    </div>
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold text-blue-700 flex items-center">
                            <i data-feather="flag" class="w-4 h-4 mr-2"></i>
                            End Date
                        </span>
                    </label>
                    <div class="relative">
                        <input type="date" id="endDate" class="date-input-enhanced w-full" onchange="updateReportPreview()" placeholder="Select end date">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <i data-feather="calendar" class="w-4 h-4 text-blue-400"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="info-box">
                <div class="flex items-center text-sm">
                    <i data-feather="info" class="w-4 h-4 mr-2"></i>
                    <span>Reports will be generated based on attendance records within the selected date range.</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Place Download Per Day Report button above the Per Day card -->
    <button onclick="downloadReport('per_day')" class="btn mb-4 border border-blue-300 rounded-full px-6 py-2 font-semibold shadow-sm" style="background: linear-gradient(90deg, #e0f2fe 0%, #bae6fd 100%); color: #1e40af;">
        <i data-feather="download" class="mr-2"></i>Download Per Day Report
    </button>
    <!-- Per Day Section -->
    <div class="card bg-base-100 shadow-xl mb-8">
        <div class="card-body">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-4">
                <h2 class="card-title flex items-center">Report Preview (Per Day)
                    <span class="tooltip ml-2" data-tip="This is a preview of how your exported report will look">
                        <i data-feather="info" class="w-5 h-5 text-info"></i>
                    </span>
                </h2>
                <button id="toggleCustomFieldsPerDay" class="btn btn-primary font-semibold px-5 py-2 w-full sm:w-auto" onclick="toggleCustomFields('perDay')">
                    <i class="fas fa-cogs mr-2"></i>Custom Report Fields
                </button>
            </div>
            <div id="customFieldsWindowPerDay" class="mb-6 bg-blue-50 border border-blue-200 rounded-xl shadow-lg p-6 relative" style="display:none;">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="card-title text-blue-800">Custom Report Fields (Per Day)</h2>
                    <button onclick="openAddReportFieldModalPerDayV2()" class="btn btn-secondary">
                        <i data-feather="plus" class="mr-2"></i>Add Custom Field
                    </button>
                </div>
                {% if custom_fields %}
                <div class="overflow-x-auto">
                    <table class="table w-full bg-white rounded-lg">
                        <thead class="bg-blue-100">
                            <tr>
                                <th>Field Name</th>
                                <th>Formula/Value</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for field in custom_fields if field.payout_type == 'per_day' or field.payout_type == 'both' %}
                            <tr>
                                <td class="font-semibold text-blue-700">{{ field.name }}</td>
                                <td class="font-mono text-blue-900">
                                    {% if field.formula %}
                                    = {{ field.formula }}
                                    {% else %}
                                    {{ field.value }}
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="flex gap-2">
                                        <button onclick="editReportField({{ field.id }}, '{{ field.name }}', '{{ field.formula }}', 'per_day')" class="btn btn-ghost btn-sm text-blue-600 hover:text-blue-800">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteReportField({{ field.id }})" class="btn btn-ghost btn-sm text-red-600 hover:text-red-800">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4 text-gray-500">
                    No custom fields defined yet. Click "Add Custom Field" to create one.
                </div>
                {% endif %}
            </div>
            <div class="overflow-x-auto">
                <table class="table w-full">
                    <thead>
                        <tr>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Task Name</th>
                            <th>Attendance Days</th>
                            <th>Daily Rate</th>
                            {% for field in import_fields %}
                            <th>{{ field.name }}</th>
                            {% endfor %}
                            {% for field in custom_fields if field.payout_type == 'per_day' or field.payout_type == 'both' %}
                            <th>{{ field.name }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in per_day_records %}
                        <tr>
                            <td>{{ record.first_name }}</td>
                            <td>{{ record.last_name }}</td>
                            <td>{{ record.task_name }}</td>
                            <td>{{ record.attendance_days }}</td>
                            <td>K{{ record.daily_rate }}</td>
                            {% for field in import_fields %}
                            <td>{{ record[field.name] }}</td>
                            {% endfor %}
                            {% for field in custom_fields if field.payout_type == 'per_day' or field.payout_type == 'both' %}
                            <td>
                            {% if field.field_type == 'numeric' %}
                                {{ "{:.2f}".format(record[field.name]) if record[field.name] is not none else '' }}
                            {% else %}
                                {{ record[field.name] }}
                            {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if per_day_records|length == 0 %}
                <div class="text-center py-4 text-gray-500">
                    No per day records found for the selected date range.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Place Download Per Unit Report button above the Per Unit card -->
    <button onclick="downloadReport('per_part')" class="btn mb-4 border border-blue-300 rounded-full px-6 py-2 font-semibold shadow-sm" style="background: linear-gradient(90deg, #e0f2fe 0%, #bae6fd 100%); color: #1e40af;">
        <i data-feather="download" class="mr-2"></i>Download Per Unit Report
    </button>
    <!-- Per Unit Section -->
    <div class="card bg-base-100 shadow-xl mb-8">
        <div class="card-body">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-4">
                <h2 class="card-title flex items-center">Report Preview (Per Unit)
                    <span class="tooltip ml-2" data-tip="This is a preview of how your exported report will look">
                        <i data-feather="info" class="w-5 h-5 text-info"></i>
                    </span>
                </h2>
                <button id="toggleCustomFieldsPerPart" class="btn btn-primary font-semibold px-5 py-2 w-full sm:w-auto" onclick="toggleCustomFields('perPart')">
                    <i class="fas fa-cogs mr-2"></i>Custom Report Fields
                </button>
            </div>
            <div id="customFieldsWindowPerPart" class="mb-6 bg-blue-50 border border-blue-200 rounded-xl shadow-lg p-6 relative" style="display:none;">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="card-title text-blue-800">Custom Report Fields (Per Unit)</h2>
                    <button onclick="openAddReportFieldModalPerUnitV2()" class="btn btn-secondary">
                        <i data-feather="plus" class="mr-2"></i>Add Custom Field
                    </button>
                </div>
                {% if custom_fields %}
                <div class="overflow-x-auto">
                    <table class="table w-full bg-white rounded-lg">
                        <thead class="bg-blue-100">
                            <tr>
                                <th>Field Name</th>
                                <th>Formula/Value</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for field in custom_fields if field.payout_type == 'per_part' or field.payout_type == 'both' %}
                            <tr>
                                <td class="font-semibold text-blue-700">{{ field.name }}</td>
                                <td class="font-mono text-blue-900">
                                    {% if field.formula %}
                                    = {{ field.formula }}
                                    {% else %}
                                    {{ field.value }}
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="flex gap-2">
                                        <button onclick="editReportField({{ field.id }}, '{{ field.name }}', '{{ field.formula }}', 'per_part')" class="btn btn-ghost btn-sm text-blue-600 hover:text-blue-800">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteReportField({{ field.id }})" class="btn btn-ghost btn-sm text-red-600 hover:text-red-800">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4 text-gray-500">
                    No custom fields defined yet. Click "Add Custom Field" to create one.
                </div>
                {% endif %}
            </div>
            <div class="overflow-x-auto">
                <table class="table w-full">
                    <thead>
                        <tr>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Task Name</th>
                            <th>Units Completed</th>
                            <th>Per Unit Rate</th>
                            {% for field in import_fields %}
                            <th>{{ field.name }}</th>
                            {% endfor %}
                            {% for field in custom_fields if field.payout_type == 'per_part' or field.payout_type == 'both' %}
                            <th>{{ field.name }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in per_part_records %}
                        <tr>
                            <td>{{ record.first_name }}</td>
                            <td>{{ record.last_name }}</td>
                            <td>{{ record.task_name }}</td>
                            <td>{{ record.units_completed }}</td>
                            <td>
                                {% if record.per_part_rate and record.per_part_currency %}
                                    {{ record.per_part_currency }} {{ record.per_part_rate }}
                                {% elif record.per_part_rate %}
                                    {{ record.per_part_rate }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            {% for field in import_fields %}
                            <td>{{ record[field.name] }}</td>
                            {% endfor %}
                            {% for field in custom_fields if field.payout_type == 'per_part' or field.payout_type == 'both' %}
                            <td>
                            {% if field.field_type == 'numeric' %}
                                {% set val = record[field.name] %}
                                {% if val is not none and val is number %}
                                    {{ '{:.2f}'.format(val) }}
                                {% elif val is not none %}
                                    {{ val }}
                                {% else %}
                                    -
                                {% endif %}
                            {% else %}
                                {{ record[field.name] }}
                            {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if per_part_records|length == 0 %}
                <div class="text-center py-4 text-gray-500">
                    No per part records found for the selected date range.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
    {% include 'modals/add_report_field.html' %}
{% endblock %}

{% block scripts %}
<script>
    function closeAddReportFieldModal() {
        const modal = document.getElementById('add-report-field-modal');
        modal.close();
        // Reset the form
        const form = document.getElementById('reportFieldForm');
        form.reset();
        // Reset formula preview and validation
        document.getElementById('formulaBuilder').value = '';
        document.getElementById('formulaError').classList.add('hidden');
        document.getElementById('previewTable').innerHTML = '';
    }
    // Expose custom fields and their formulas to JS
    const customFields = [{% for field in custom_fields %}{ name: {{ field.name|tojson }}, formula: {{ field.formula|tojson }}, max_limit: {{ field.max_limit|tojson }} }{% if not loop.last %},{% endif %}{% endfor %}];

    function getCustomFieldFormula(name) {
        const field = customFields.find(f => f.name === name);
        return field ? field.formula : null;
    }
    function getCustomFieldMaxLimit(name) {
        const field = customFields.find(f => f.name === name);
        return field ? field.max_limit : null;
    }

    // Recursively calculate a field value for a row
    function calculateFieldValue(fieldName, row, visited = new Set()) {
        if (visited.has(fieldName)) return 0; // Prevent circular refs
        visited.add(fieldName);
        const formula = getCustomFieldFormula(fieldName);
        const maxLimit = getCustomFieldMaxLimit(fieldName);
        if (!formula) return row[fieldName] || 0;
        // Find all referenced fields
        const fieldRegex = /[a-zA-Z_][a-zA-Z0-9_]*/g;
        let evalFormula = formula;
        const fieldsInFormula = Array.from(new Set(formula.match(fieldRegex) || []));
        for (const refField of fieldsInFormula) {
            let value;
            if (getCustomFieldFormula(refField)) {
                value = calculateFieldValue(refField, row, visited);
            } else {
                value = row[refField] || 0;
            }
            const re = new RegExp(`\\b${refField}\\b`, 'g');
            evalFormula = evalFormula.replace(re, value);
        }
        try {
            let result = eval(evalFormula);
            if (maxLimit !== null && maxLimit !== undefined) {
                result = Math.min(result, maxLimit);
            }
            return result;
        } catch {
            return 0;
        }
    }

    function updateReportPreview() {
        console.log('updateReportPreview called');
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        console.log('Start date:', startDate);
        console.log('End date:', endDate);
        
        if (!startDate || !endDate) {
            console.log('Missing start or end date');
            return;
        }
        
        if (new Date(endDate) < new Date(startDate)) {
            showCustomModal('Date Validation', 'End date cannot be before start date', 'warning');
            // Set end date to 1 day after start date
            const newEndDate = new Date(startDate);
            newEndDate.setDate(newEndDate.getDate() + 1);
            const formattedEndDate = newEndDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = formattedEndDate;
            
            // Update the report with the corrected date
            const newUrl = `/reports?start_date=${startDate}&end_date=${formattedEndDate}`;
            console.log('Redirecting to:', newUrl);
            window.location.href = newUrl;
            return;
        }
        
        const newUrl = `/reports?start_date=${startDate}&end_date=${endDate}`;
        console.log('Redirecting to:', newUrl);
        window.location.href = newUrl;
    }
    
    function showReportErrorModal(message) {
        // Make the first sentence bold if it matches 'This report is empty'
        let html = message;
        const emptyPrefix = 'This report is empty';
        if (message.startsWith(emptyPrefix)) {
            const rest = message.slice(emptyPrefix.length);
            html = `<span class='font-bold text-red-700'>${emptyPrefix}</span>${rest}`;
        }
        document.getElementById('reportErrorMessage').innerHTML = html;
        document.getElementById('reportErrorModal').style.display = '';
    }
    function closeReportErrorModal() {
        document.getElementById('reportErrorModal').style.display = 'none';
    }

    function downloadReport(reportType) {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        if (!startDate || !endDate) {
            showReportErrorModal('Please select both start and end dates');
            return;
        }
        
        if (new Date(endDate) < new Date(startDate)) {
            showReportErrorModal('End date cannot be before start date');
            // Set end date to 1 day after start date
            const newEndDate = new Date(startDate);
            newEndDate.setDate(newEndDate.getDate() + 1);
            const formattedEndDate = newEndDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = formattedEndDate;
            
            // Download report with the corrected date
            window.location.href = `/report/download?start_date=${startDate}&end_date=${formattedEndDate}&report_type=${reportType}`;
            return;
        }
        
        // Use fetch to get the report and handle errors
        const url = `/report/download?start_date=${startDate}&end_date=${endDate}&report_type=${reportType}`;
        fetch(url)
            .then(async response => {
                if (!response.ok) {
                    let errorMsg = 'Failed to download report.';
                    try {
                        const data = await response.json();
                        if (data && data.error) errorMsg = data.error;
                    } catch (e) {}
                    showReportErrorModal(errorMsg);
                    throw new Error(errorMsg);
                }
                // If response is a file, download it
                const blob = await response.blob();
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'report.xlsx';
                if (contentDisposition) {
                    const match = contentDisposition.match(/filename="?([^";]+)"?/);
                    if (match) filename = match[1];
                }
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            })
            .catch(err => {
                // Already handled above
            });
    }

    function insertAtCursor(textarea, text) {
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const before = textarea.value.substring(0, start);
        const after = textarea.value.substring(end);
        textarea.value = before + text + after;
        textarea.selectionStart = textarea.selectionEnd = start + text.length;
        textarea.focus();
    }

    function insertOperator(op) {
        const formulaBuilder = document.getElementById('formulaBuilder');
        insertAtCursor(formulaBuilder, ` ${op} `);
    }

    async function insertNumber() {
        const number = await showCustomConfirm('Input Required', 'Enter a number:');
        if (number && !isNaN(number)) {
            const formulaBuilder = document.getElementById('formulaBuilder');
            insertAtCursor(formulaBuilder, ` ${number} `);
        }
    }

    document.getElementById('fieldPicker').addEventListener('change', function() {
        const field = this.value;
        if (field) {
            const formulaBuilder = document.getElementById('formulaBuilder');
            insertAtCursor(formulaBuilder, ` ${field} `);
        }
    });

    // Add event listener for formula changes
    document.getElementById('formulaBuilder').addEventListener('input', updateFormulaPreview);
    


    function editReportField(id, name, formula, payout_type) {
        editingFieldName = name;
        editingFieldId = id;
        if (payout_type === 'per_day') {
            document.querySelector('#reportFieldFormPerDay input[name="name"]').value = name;
            document.querySelector('#reportFieldFormPerDay input[name="field_id"]').value = id; // Set field_id
            document.getElementById('formulaBuilderPerDay').value = formula;
            // Set max limit toggle and value
            const field = customFields.find(f => f.name === name);
            if (field && field.max_limit !== null && field.max_limit !== undefined) {
                document.getElementById('enableMaxLimitPerDay').checked = true;
                document.getElementById('maxLimitInputWrapperPerDay').classList.remove('hidden');
                document.getElementById('maxLimitValuePerDay').value = field.max_limit;
            } else {
                document.getElementById('enableMaxLimitPerDay').checked = false;
                document.getElementById('maxLimitInputWrapperPerDay').classList.add('hidden');
                document.getElementById('maxLimitValuePerDay').value = '';
            }
            document.getElementById('add-report-field-modal-per-day').showModal();
            if (typeof registerFormulaBuilderEvents === 'function') registerFormulaBuilderEvents();
        } else if (payout_type === 'per_part') {
            document.querySelector('#reportFieldFormPerUnit input[name="name"]').value = name;
            document.querySelector('#reportFieldFormPerUnit input[name="field_id"]').value = id; // Set field_id
            document.getElementById('formulaBuilderPerUnit').value = formula;
            // Set max limit toggle and value
            const field = customFields.find(f => f.name === name);
            if (field && field.max_limit !== null && field.max_limit !== undefined) {
                document.getElementById('enableMaxLimitPerUnit').checked = true;
                document.getElementById('maxLimitInputWrapperPerUnit').classList.remove('hidden');
                document.getElementById('maxLimitValuePerUnit').value = field.max_limit;
            } else {
                document.getElementById('enableMaxLimitPerUnit').checked = false;
                document.getElementById('maxLimitInputWrapperPerUnit').classList.add('hidden');
                document.getElementById('maxLimitValuePerUnit').value = '';
            }
            document.getElementById('add-report-field-modal-per-unit').showModal();
            if (typeof registerFormulaBuilderEvents === 'function') registerFormulaBuilderEvents();
        }
    }

    function openAddReportFieldModal(payout_type) {
        editingFieldName = null;
        editingFieldId = null;
        document.getElementById('reportFieldForm').reset();
        document.getElementById('previewTable').innerHTML = '';
        document.getElementById('add-report-field-modal').showModal();
        updateCustomFieldsDropdown();
        document.getElementById('maxLimitInputWrapper').classList.add('hidden');
        document.getElementById('enableMaxLimit').checked = false;
        document.getElementById('maxLimitValue').value = '';
    }

    function openAddReportFieldModalPerDay() {
        editingFieldName = null;
        editingFieldId = null;
        document.getElementById('reportFieldForm').reset();
        document.getElementById('previewTable').innerHTML = '';
        document.getElementById('add-report-field-modal').showModal();
        updateCustomFieldsDropdown();
        document.getElementById('maxLimitInputWrapper').classList.add('hidden');
        document.getElementById('enableMaxLimit').checked = false;
        document.getElementById('maxLimitValue').value = '';
    }

    function openAddReportFieldModalPerUnit() {
        editingFieldName = null;
        editingFieldId = null;
        document.getElementById('reportFieldForm').reset();
        document.getElementById('previewTable').innerHTML = '';
        document.getElementById('add-report-field-modal').showModal();
        updateCustomFieldsDropdown();
        document.getElementById('maxLimitInputWrapper').classList.add('hidden');
        document.getElementById('enableMaxLimit').checked = false;
        document.getElementById('maxLimitValue').value = '';
    }

    function updateCustomFieldsDropdown() {
        const fieldPicker = document.getElementById('fieldPicker');
        // Remove all custom field options
        const customOptGroup = fieldPicker.querySelector('optgroup[label="Custom Fields"]');
        if (customOptGroup) customOptGroup.innerHTML = '';
        // Add custom fields except the one being edited
        customFields.forEach(field => {
            if (!editingFieldName || field.name !== editingFieldName) {
                const option = document.createElement('option');
                option.value = field.name;
                option.textContent = field.name;
                customOptGroup && customOptGroup.appendChild(option);
            }
        });
    }

    async function deleteReportField(fieldId) {
        const confirmed = await showCustomConfirm('Confirm Delete', 'Are you sure you want to delete this field?');
        if (confirmed) {
            fetch(`/api/report-field?id=${fieldId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    showCustomModal('Delete Error', result.error, 'error');
                } else {
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error deleting report field:', error);
                showCustomModal('Delete Error', 'Failed to delete report field', 'error');
            });
        }
    }
    
    function validateFormula() {
        let formula = document.getElementById('formulaBuilder').value;
        
        // Replace custom field references with their formulas
        for (const [fieldName, fieldFormula] of Object.entries(customFields)) {
            const regex = new RegExp(fieldName, 'g');
            formula = formula.replace(regex, `(${fieldFormula})`);
        }
        const errorDiv = document.getElementById('formulaError');
        const previewTable = document.getElementById('previewTable');
        
        try {
            // Sample data for preview
            const testData = [
                {name: 'John Doe', attendance_days: 20, daily_rate: 100},
                {name: 'Jane Smith', attendance_days: 15, daily_rate: 100},
                {name: 'Bob Wilson', attendance_days: 22, daily_rate: 100}
            ];

            // Clear previous preview
            previewTable.innerHTML = '';

            // Test formula with sample data
            testData.forEach(worker => {
                const row = document.createElement('tr');
                const evalFormula = formula
                    .replace(/attendance_days/g, worker.attendance_days)
                    .replace(/daily_rate/g, worker.daily_rate);
                
                const result = eval(evalFormula);

                row.innerHTML = `
                    <td>${worker.name}</td>
                    <td>${worker.attendance_days}</td>
                    <td>${worker.daily_rate}</td>
                    <td>${isNaN(result) ? 'Invalid' : result.toFixed(2)}</td>
                `;
                previewTable.appendChild(row);
            });

            errorDiv.classList.add('hidden');
        } catch (e) {
            errorDiv.classList.remove('hidden');
            errorDiv.textContent = 'Invalid formula: ' + e.message;
        }
    }

    // Handle report field form submission
    document.getElementById('reportFieldForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const fieldId = formData.get('field_id');
        const data = {
            name: formData.get('name'),
            formula: formData.get('formula')
        };
        
        const url = fieldId ? `/api/report-field?id=${fieldId}` : '/api/report-field';
        const method = fieldId ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                showCustomModal('Save Error', result.error, 'error');
            } else {
                closeAddReportFieldModal();
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error saving report field:', error);
            showCustomModal('Save Error', 'Failed to save report field', 'error');
        });
    });

    function toggleCustomFields(section) {
        if (section === 'perDay') {
            const win = document.getElementById('customFieldsWindowPerDay');
            win.style.display = win.style.display === 'none' ? '' : 'none';
        } else if (section === 'perPart') {
            const win = document.getElementById('customFieldsWindowPerPart');
            win.style.display = win.style.display === 'none' ? '' : 'none';
        }
    }

    function editReportField(fieldId, fieldName, fieldFormula, payoutType) {
        console.log(`Editing field: ${fieldName}`);
        // Ensure proper escaping of field data
        const sanitizedFieldName = fieldName.replace(/'/g, "\'");
        const sanitizedFieldFormula = fieldFormula.replace(/'/g, "\'");
        // Open modal with sanitized data
        openEditModal(fieldId, sanitizedFieldName, sanitizedFieldFormula, payoutType);
    }

    function deleteReportField(fieldId) {
        if (confirm('Are you sure you want to delete this field?')) {
            fetch(`/api/report-field/${fieldId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    alert('Field deleted successfully');
                    location.reload();
                } else {
                    alert('Failed to delete field');
                }
            })
            .catch(error => console.error('Error:', error));
        }
    }
</script>

<style>
.gradient-header th {
    background: linear-gradient(90deg, #2563eb 0%, #60a5fa 100%);
    color: #fff;
    font-weight: 600;
    border-top-left-radius: 1rem;
    border-top-right-radius: 1rem;
    /* Add padding for a modern look */
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
}

/* Enhanced date range styling */
.date-range-card {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%);
    border: 2px solid #bfdbfe;
    box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.1), 0 10px 10px -5px rgba(59, 130, 246, 0.04);
}

.date-range-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.1), 0 10px 10px -5px rgba(59, 130, 246, 0.04);
    transition: all 0.3s ease;
}

.date-input-enhanced {
    background: white;
    border: 2px solid #bfdbfe;
    border-radius: 0.75rem;
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #1e40af;
    transition: all 0.2s ease;
}

.date-input-enhanced:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    outline: none;
}

.date-input-enhanced:hover {
    border-color: #60a5fa;
}

.info-box {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    border: 1px solid #93c5fd;
    border-radius: 0.75rem;
    padding: 1rem;
    margin-top: 1.5rem;
}

.info-box .flex {
    align-items: center;
}

.info-box i {
    color: #2563eb;
    flex-shrink: 0;
}

.info-box span {
    color: #1e40af;
    font-weight: 500;
    line-height: 1.5;
}
.error-modal-bg {
  background: rgba(248, 113, 113, 0.10); /* soft red overlay */
}
@keyframes fadeInModal {
  from { opacity: 0; transform: translateY(30px) scale(0.98); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}
.animate-fade-in {
  animation: fadeInModal 0.25s cubic-bezier(0.4,0,0.2,1);
}

body {
    margin-top: 2rem;
}
.btn {
    margin: 0.5rem;
}
</style>
{% endblock %}