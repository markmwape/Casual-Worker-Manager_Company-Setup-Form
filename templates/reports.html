{% extends "base.html" %}

{% block content %}
<!-- Error Modal -->
<div id="reportErrorModal" class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50" style="display:none;">
  <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full relative border-t-8 border-red-200 animate-fade-in">
    <button onclick="closeReportErrorModal()" class="absolute top-3 right-4 text-gray-400 hover:text-gray-700 text-3xl font-bold">&times;</button>
    <div class="flex items-center mb-4">
      <div class="bg-red-100 rounded-full p-2 mr-3 flex items-center justify-center"><i data-feather="alert-circle" class="w-7 h-7 text-red-500"></i></div>
      <h3 class="text-xl font-semibold text-red-700">Report Error</h3>
    </div>
    <div id="reportErrorMessage" class="text-gray-800 leading-relaxed"></div>
    <div class="mt-6 text-right">
      <button onclick="closeReportErrorModal()" class="btn px-5 py-2 font-semibold rounded-lg shadow-sm" style="background: linear-gradient(90deg, #fca5a5 0%, #fecaca 100%); color: #b91c1c;">OK</button>
    </div>
  </div>
</div>

<div class="container mx-auto px-4 w-full max-w-6xl pt-8">
    <!-- Page Header -->
    <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                <i data-feather="bar-chart" class="w-6 h-6 text-white"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Reports Dashboard</h1>
                <p class="text-sm text-gray-600">Generate and download comprehensive workforce reports</p>
            </div>
        </div>
        <div class="hidden lg:flex items-center gap-2 text-sm text-gray-500">
            <i data-feather="calendar" class="w-4 h-4"></i>
            <span>Select date range to generate reports</span>
        </div>
    </div>

    <!-- Date Range Selection Card -->
    <div class="card bg-white border border-gray-200 shadow-lg mb-8">
        <div class="card-body p-6">
            <div class="flex items-center mb-6">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-md mr-4">
                    <i data-feather="calendar" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-1">Report Date Range</h2>
                    <p class="text-sm text-gray-600">Select the date range for your report generation</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold text-blue-700 flex items-center">
                            <i data-feather="play" class="w-4 h-4 mr-2"></i>
                            Start Date
                        </span>
                    </label>
                    <div class="relative">
                        <input type="date" id="startDate" class="input input-bordered w-full bg-white border-blue-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200" onchange="updateReportPreview()" placeholder="Select start date">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <i data-feather="calendar" class="w-4 h-4 text-blue-400"></i>
                        </div>
                    </div>
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold text-blue-700 flex items-center">
                            <i data-feather="flag" class="w-4 h-4 mr-2"></i>
                            End Date
                        </span>
                    </label>
                    <div class="relative">
                        <input type="date" id="endDate" class="input input-bordered w-full bg-white border-blue-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200" onchange="updateReportPreview()" placeholder="Select end date">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <i data-feather="calendar" class="w-4 h-4 text-blue-400"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 p-4 bg-blue-100/50 rounded-lg border border-blue-200">
                <div class="flex items-center text-sm text-blue-700">
                    <i data-feather="info" class="w-4 h-4 mr-2 flex-shrink-0"></i>
                    <span>Reports will be generated based on attendance records within the selected date range.</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Per Day Report Section -->
        <div class="space-y-4">
            <div class="card bg-white shadow-lg border border-green-200 hover:shadow-xl transition-all duration-300">
                <div class="card-body p-6">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-4">
                        <h4 class="text-lg font-semibold text-gray-700 flex items-center">
                            <i data-feather="eye" class="w-5 h-5 text-green-600 mr-2"></i>
                            Report Preview (Per Day)
                            <span class="tooltip ml-2" data-tip="This is a preview of how your exported report will look">
                                <i data-feather="info" class="w-4 h-4 text-gray-400"></i>
                            </span>
                        </h4>
                        <button id="toggleCustomFieldsPerDay" class="btn btn-outline btn-sm" onclick="toggleCustomFields('perDay')">
                            <i class="fas fa-cogs mr-2"></i>Custom Fields
                        </button>
                    </div>
                    
                    <div id="customFieldsWindowPerDay" class="mb-6 bg-green-50 border border-green-200 rounded-xl shadow-sm p-6 relative" style="display:none;">
                        <div class="flex justify-between items-center mb-4">
                            <h5 class="font-semibold text-green-800">Custom Report Fields (Per Day)</h5>
                            <button onclick="openAddReportFieldModalPerDayV2()" class="btn btn-sm btn-success">
                                <i data-feather="plus" class="mr-2"></i>Add Field
                            </button>
                        </div>
                        {% if custom_fields %}
                <div class="overflow-x-auto">
                    <table class="table w-full bg-white rounded-lg">
                        <thead class="bg-blue-100">
                            <tr>
                                <th>Field Name</th>
                                <th>Formula/Value</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for field in custom_fields if field.payout_type == 'per_day' or field.payout_type == 'both' %}
                            <tr>
                                <td class="font-semibold text-blue-700">{{ field.name }}</td>
                                <td class="font-mono text-blue-900">
                                    {% if field.formula %}
                                    = {{ field.formula }}
                                    {% else %}
                                    {{ field.value }}
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="flex gap-2">
                                        <button onclick="editReportField({{ field.id }}, '{{ field.name }}', '{{ field.formula }}', 'per_day')" class="btn btn-ghost btn-sm text-blue-600 hover:text-blue-800">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteReportField({{ field.id }})" class="btn btn-ghost btn-sm text-red-600 hover:text-red-800">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4 text-gray-500">
                    No custom fields defined yet. Click "Add Custom Field" to create one.
                </div>
                {% endif %}
            </div>
            <div class="overflow-x-auto">
                <table class="table w-full">
                    <thead>
                        <tr>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Task Name</th>
                            <th>Attendance Days</th>
                            <th>Daily Rate</th>
                            {% for field in import_fields %}
                            <th>{{ field.name }}</th>
                            {% endfor %}
                            {% for field in custom_fields if field.payout_type == 'per_day' or field.payout_type == 'both' %}
                            <th>{{ field.name }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in per_day_records %}
                        <tr>
                            <td>{{ record.first_name }}</td>
                            <td>{{ record.last_name }}</td>
                            <td>{{ record.task_name }}</td>
                            <td>{{ record.attendance_days }}</td>
                            <td>K{{ record.daily_rate }}</td>
                            {% for field in import_fields %}
                            <td>{{ record[field.name] }}</td>
                            {% endfor %}
                            {% for field in custom_fields if field.payout_type == 'per_day' or field.payout_type == 'both' %}
                            <td>
                            {% if field.field_type == 'numeric' %}
                                {{ "{:.2f}".format(record[field.name]) if record[field.name] is not none else '' }}
                            {% else %}
                                {{ record[field.name] }}
                            {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if per_day_records|length == 0 %}
                <div class="text-center py-4 text-gray-500">
                    No per day records found for the selected date range.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Download Per Day Report Button -->
    <button onclick="downloadReport('per_day')" class="btn btn-success shadow-lg hover:shadow-xl transition-all duration-200 mb-4">
        <i data-feather="download" class="mr-2"></i>Download Per Day Report
    </button>
    
    <!-- Per Unit Section -->
    <div class="card bg-base-100 shadow-xl mb-8">
        <div class="card-body">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-4">
                <h2 class="card-title flex items-center">Report Preview (Per Unit)
                    <span class="tooltip ml-2" data-tip="This is a preview of how your exported report will look">
                        <i data-feather="info" class="w-5 h-5 text-info"></i>
                    </span>
                </h2>
                <button id="toggleCustomFieldsPerPart" class="btn btn-primary font-semibold px-5 py-2 w-full sm:w-auto" onclick="toggleCustomFields('perPart')">
                    <i class="fas fa-cogs mr-2"></i>Custom Report Fields
                </button>
            </div>
            <div id="customFieldsWindowPerPart" class="mb-6 bg-white border border-gray-200 rounded-xl shadow-lg p-6 relative" style="display:none;">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="card-title text-blue-800">Custom Report Fields (Per Unit)</h2>
                    <button onclick="openAddReportFieldModalPerUnitV2()" class="btn btn-secondary">
                        <i data-feather="plus" class="mr-2"></i>Add Custom Field
                    </button>
                </div>
                {% if custom_fields %}
                <div class="overflow-x-auto">
                    <table class="table w-full bg-white rounded-lg">
                        <thead class="bg-blue-100">
                            <tr>
                                <th>Field Name</th>
                                <th>Formula/Value</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for field in custom_fields if field.payout_type == 'per_part' or field.payout_type == 'both' %}
                            <tr>
                                <td class="font-semibold text-blue-700">{{ field.name }}</td>
                                <td class="font-mono text-blue-900">
                                    {% if field.formula %}
                                    = {{ field.formula }}
                                    {% else %}
                                    {{ field.value }}
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="flex gap-2">
                                        <button onclick="editReportField({{ field.id }}, '{{ field.name }}', '{{ field.formula }}', 'per_part')" class="btn btn-ghost btn-sm text-blue-600 hover:text-blue-800">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteReportField({{ field.id }})" class="btn btn-ghost btn-sm text-red-600 hover:text-red-800">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4 text-gray-500">
                    No custom fields defined yet. Click "Add Custom Field" to create one.
                </div>
                {% endif %}
            </div>
            <div class="overflow-x-auto">
                <table class="table w-full">
                    <thead>
                        <tr>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Task Name</th>
                            <th>Units Completed</th>
                            <th>Per Unit Rate</th>
                            {% for field in import_fields %}
                            <th>{{ field.name }}</th>
                            {% endfor %}
                            {% for field in custom_fields if field.payout_type == 'per_part' or field.payout_type == 'both' %}
                            <th>{{ field.name }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in per_part_records %}
                        <tr>
                            <td>{{ record.first_name }}</td>
                            <td>{{ record.last_name }}</td>
                            <td>{{ record.task_name }}</td>
                            <td>{{ record.units_completed }}</td>
                            <td>
                                {% if record.per_part_rate and record.per_part_currency %}
                                    {{ record.per_part_currency }} {{ record.per_part_rate }}
                                {% elif record.per_part_rate %}
                                    {{ record.per_part_rate }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            {% for field in import_fields %}
                            <td>{{ record[field.name] }}</td>
                            {% endfor %}
                            {% for field in custom_fields if field.payout_type == 'per_part' or field.payout_type == 'both' %}
                            <td>
                            {% if field.field_type == 'numeric' %}
                                {% set val = record[field.name] %}
                                {% if val is not none and val is number %}
                                    {{ '{:.2f}'.format(val) }}
                                {% elif val is not none %}
                                    {{ val }}
                                {% else %}
                                    -
                                {% endif %}
                            {% else %}
                                {{ record[field.name] }}
                            {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if per_part_records|length == 0 %}
                <div class="text-center py-4 text-gray-500">
                    No per part records found for the selected date range.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Download Per Unit Report Button -->
    <button onclick="downloadReport('per_part')" class="btn btn-primary shadow-lg hover:shadow-xl transition-all duration-200">
        <i data-feather="download" class="mr-2"></i>Download Per Unit Report
    </button>
</div>
    {% include 'modals/add_report_field.html' %}
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace();
    });
</script>
{% endblock %}

<style>
.gradient-header th {
    background: linear-gradient(90deg, #2563eb 0%, #60a5fa 100%);
    color: #fff;
    font-weight: 600;
    border-top-left-radius: 1rem;
    border-top-right-radius: 1rem;
    /* Add padding for a modern look */
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
}

/* Enhanced date range styling */
.date-range-card {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%);
    border: 2px solid #bfdbfe;
    box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.1), 0 10px 10px -5px rgba(59, 130, 246, 0.04);
}

.date-range-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.1), 0 10px 10px -5px rgba(59, 130, 246, 0.04);
    transition: all 0.3s ease;
}

.date-input-enhanced {
    background: white;
    border: 2px solid #bfdbfe;
    border-radius: 0.75rem;
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #1e40af;
    transition: all 0.2s ease;
}

.date-input-enhanced:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    outline: none;
}

.date-input-enhanced:hover {
    border-color: #60a5fa;
}

.info-box {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    border: 1px solid #93c5fd;
    border-radius: 0.75rem;
    padding: 1rem;
    margin-top: 1.5rem;
}

.info-box .flex {
    align-items: center;
}

.info-box i {
    color: #2563eb;
    flex-shrink: 0;
}

.info-box span {
    color: #1e40af;
    font-weight: 500;
    line-height: 1.5;
}
.error-modal-bg {
  background: rgba(248, 113, 113, 0.10); /* soft red overlay */
}
@keyframes fadeInModal {
  from { opacity: 0; transform: translateY(30px) scale(0.98); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}
.animate-fade-in {
  animation: fadeInModal 0.25s cubic-bezier(0.4,0,0.2,1);
}

body {
    margin-top: 2rem;
}
.btn {
    margin: 0.5rem;
}
</style>