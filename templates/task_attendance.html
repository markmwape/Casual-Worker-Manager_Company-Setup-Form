{% extends "base_with_sidebar.html" %}

{% block head %}
<style>
    /* Attendance button styles */
    .attendance-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 16px;
        border: 2px solid transparent;
        border-radius: 8px;
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 100px;
        user-select: none;
    }
    
    .present-btn {
        background-color: #f0f9f4;
        color: #166534;
        border-color: #dcfce7;
    }
    
    .present-btn:hover {
        background-color: #dcfce7;
        border-color: #bbf7d0;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
    }
    
    .present-btn.active {
        background-color: #22c55e;
        color: white;
        border-color: #16a34a;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }
    
    .absent-btn {
        background-color: #fef2f2;
        color: #dc2626;
        border-color: #fecaca;
    }
    
    .absent-btn:hover {
        background-color: #fecaca;
        border-color: #fca5a5;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
    }
    
    .absent-btn.active {
        background-color: #ef4444;
        color: white;
        border-color: #dc2626;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    /* Hide the actual radio buttons */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }
    
    /* Responsive design for mobile */
    @media (max-width: 640px) {
        .attendance-btn {
            min-width: 80px;
            padding: 6px 12px;
            font-size: 13px;
        }
    }
    
    /* Animation for button state changes */
    .attendance-btn {
        animation: none;
    }
    
    .attendance-btn.active {
        animation: pulse 0.3s ease-in-out;
    }
    
    @keyframes pulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
        100% {
            transform: scale(1);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 w-full max-w-6xl pt-8 attendance-container" data-onboarding="attendance-container">
    <!-- Desktop header and actions -->
    <div class="hidden lg:flex items-center justify-between mb-6">
        <div class="text-2xl font-bold text-black">
            Task Attendance: {{ task.name }}
        </div>
        <div class="flex gap-2">
            <button onclick="openAddWorkerToTaskModal('{{ task.id }}')" class="btn btn-primary">
                <i data-feather="plus" class="mr-2"></i>Add Worker
            </button>
            <a href="{{ url_for('tasks_route') }}" class="btn btn-ghost">
                <i data-feather="arrow-left" class="mr-2"></i>Back to Tasks
            </a>
        </div>
    </div>
    <!-- Mobile header -->
    <div class="lg:hidden mb-6">
        <div class="text-2xl font-bold text-black mb-4">
            Task Attendance: {{ task.name }}
        </div>
        <div class="flex flex-col gap-2">
            <button onclick="openAddWorkerToTaskModal('{{ task.id }}')" class="btn btn-primary">
                <i data-feather="plus" class="mr-2"></i>Add Worker
            </button>
            <a href="{{ url_for('tasks_route') }}" class="btn btn-ghost">
                <i data-feather="arrow-left" class="mr-2"></i>Back to Tasks
            </a>
        </div>
    </div>

    {% if selected_date < task.start_date.date() %}
        <div class="alert alert-error mb-4">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            {% if task.payment_type == 'per_part' %}
                Units cannot be recorded before the task’s start date.
            {% else %}
                Attendance cannot be recorded before the task’s start date.
            {% endif %}
        </div>
        <div class="flex justify-center mb-8">
            <a href="{{ url_for('task_attendance_route', task_id=task.id, date=task.start_date.strftime('%Y-%m-%d')) }}" class="btn btn-primary">
                <i class="fas fa-calendar-day mr-2"></i>Back to Today
            </a>
        </div>
    {% elif task.status in ['In Progress', 'Completed'] %}
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <div class="text-center mb-4 flex flex-col items-center justify-center">
                    <div class="flex items-center space-x-6 justify-center w-full">
                        <button 
                            onclick="changeDate(-1)" 
                            class="gradient-circle-btn shadow-md flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-brand-navy-400"
                            aria-label="Previous Day"
                        >
                            <i data-feather="chevron-left" class="w-6 h-6"></i>
                        </button>
                        <h2 class="text-2xl font-bold text-black mx-4">
                            <span id="localDate">{{ selected_date.strftime('%A, %B %d, %Y') }}</span>
                        </h2>
                        <button 
                            onclick="changeDate(1)" 
                            class="gradient-circle-btn shadow-md flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-brand-navy-400"
                            aria-label="Next Day"
                        >
                            <i data-feather="chevron-right" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <input 
                        type="date" 
                        id="taskDateInput" 
                        class="input input-bordered mt-2" 
                        value="{{ selected_date.strftime('%Y-%m-%d') }}"
                        min="{{ task_start_date }}"
                        placeholder="Select task date"
                        onchange="onAttendanceDateChange()"
                    >
                    <!-- Search icon and bar (moved here, responsive for mobile) -->
                    <div class="flex flex-col sm:flex-row justify-end items-stretch sm:items-center mt-2 w-full gap-2">
                        <div class="flex justify-end items-center w-full sm:max-w-xs mx-auto">
                            <button id="showSearchBtn" class="p-2 rounded-full hover:bg-gray-50 focus:outline-none" onclick="toggleAttendanceSearch()">
                                <i data-feather="search"></i>
                            </button>
                            <div id="attendanceSearchBar" class="hidden ml-2 w-full sm:max-w-xs">
                                <div class="flex items-center bg-white border border-brand-navy-200 rounded-lg px-2 py-1 shadow">
                                    <input id="attendanceSearchInput" type="text" class="flex-1 outline-none bg-transparent px-2 py-1 text-sm" placeholder="Search by any field..." oninput="filterAttendanceRows()">
                                    <button class="ml-2 text-gray-400 hover:text-brand-navy-600" onclick="toggleAttendanceSearch()" type="button"><i data-feather="x"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Add error div above the form -->
                <div id="attendance-date-error" class="alert alert-error mb-4 hidden" style="display:none;">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    You cannot select a date before the task's start date ({{ task_start_date }}).
                </div>
                <form id="attendanceForm" data-per-part="{{ 'true' if task.payment_type == 'per_part' else 'false' }}">
                    <table class="table w-full attendance-table" data-onboarding="attendance-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                {% if task.payment_type == 'per_part' %}
                                    <th>Units Completed</th>
                                {% else %}
                                    <th>Present</th>
                                    <th>Absent</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in attendance_records %}
                            <tr
                                data-worker-fields="{{ record.worker.first_name }} {{ record.worker.last_name }}{% if record.worker.date_of_birth %} {{ record.worker.date_of_birth.strftime('%Y-%m-%d') }}{% endif %} {% for cf in record.worker.custom_field_values %} {{ cf.value }}{% endfor %} {{ record.worker.id }}"
                            >
                                <td>{{ record.worker.first_name }} {{ record.worker.last_name }}</td>
                                {% if task.payment_type == 'per_part' %}
                                    <td>
                                        <input type="number" min="0" step="1" name="units_{{ record.worker.id }}" class="input input-bordered w-32" value="{{ (record.units_completed or '')|int if record.units_completed is not none else '' }}" placeholder="e.g. 5" inputmode="numeric" pattern="[0-9]*" data-onboarding="units-input">
                                    </td>
                                {% else %}
                                    <td>
                                        <label class="flex items-center justify-center cursor-pointer">
                                            <input type="radio" 
                                                   name="attendance_{{ record.worker.id }}" 
                                                   class="sr-only" 
                                                   value="present"
                                                   {{ 'checked' if record.status == 'Present' else '' }}
                                                   data-onboarding="attendance-checkbox">
                                            <div class="attendance-btn present-btn {{ 'active' if record.status == 'Present' else '' }}">
                                                <i class="fas fa-check mr-1"></i>
                                                Present
                                            </div>
                                        </label>
                                    </td>
                                    <td>
                                        <label class="flex items-center justify-center cursor-pointer">
                                            <input type="radio" 
                                                   name="attendance_{{ record.worker.id }}" 
                                                   class="sr-only" 
                                                   value="absent"
                                                   {{ 'checked' if record.status == 'Absent' else '' }}>
                                            <div class="attendance-btn absent-btn {{ 'active' if record.status == 'Absent' else '' }}">
                                                <i class="fas fa-times mr-1"></i>
                                                Absent
                                            </div>
                                        </label>
                                    </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div class="mt-4 flex justify-end">
                        <button type="button" onclick="saveAttendance({{ task.id }})" class="btn btn-primary" data-onboarding="save-attendance">
                            <i data-feather="save" class="mr-2"></i>Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
    {% else %}
        <div class="alert alert-info mt-8">
            <i class="fas fa-info-circle mr-2"></i>
            Attendance is only available for tasks that are In Progress or Completed.
        </div>
    {% endif %}

    {% include 'modals/add_worker_to_task.html' %}
</div>
{% endblock %}

{% block scripts %}
<script>
    function saveAttendance(taskId) {
        console.log('Starting to save attendance for task:', taskId); // Debug log
        
        const attendanceData = [];
        const rows = document.querySelectorAll('#attendanceForm tbody tr');
        const selectedDate = document.getElementById('taskDateInput').value;
        const taskStartDate = '{{ task_start_date }}';
        
        console.log('Selected date:', selectedDate, 'Task start date:', taskStartDate); // Debug log
        
        // Check if selected date is before task start date
        if (selectedDate < taskStartDate) {
            const warning = document.getElementById('attendance-date-error');
            warning.style.display = '';
            warning.classList.remove('hidden');
            warning.scrollIntoView({behavior: 'smooth'});
            return;
        } else {
            const warning = document.getElementById('attendance-date-error');
            warning.style.display = 'none';
            warning.classList.add('hidden');
        }
        
        const isPerPart = document.getElementById('attendanceForm').dataset.perPart === 'true';
        console.log('Is per part task:', isPerPart); // Debug log
        
        rows.forEach(row => {
            const workerNameCell = row.querySelector('td:first-child');
            if (isPerPart) {
                // For per_part, get units completed
                const unitsInput = row.querySelector('input[type="number"]');
                if (unitsInput) {
                    const units = unitsInput.value ? parseInt(unitsInput.value, 10) || 0 : 0;
                    const workerId = unitsInput.name.split('_')[1];
                    console.log(`Worker ${workerId}: ${units} units completed`); // Debug log
                    attendanceData.push({
                        worker_id: workerId,
                        units_completed: units
                    });
                }
            } else {
                // For per_day, get present/absent
                const presentRadio = row.querySelector('input[value="present"]');
                const absentRadio = row.querySelector('input[value="absent"]');
                if (presentRadio) {
                    const workerId = presentRadio.getAttribute('name').split('_')[1];
                    const status = presentRadio.checked ? 'Present' : 'Absent';
                    console.log(`Worker ${workerId}: ${status}`); // Debug log
                    attendanceData.push({
                        worker_id: workerId,
                        status: status
                    });
                }
            }
        });

        console.log('Final attendance data:', attendanceData); // Debug log

        // Show loading state
        const saveBtn = document.querySelector('button[onclick*="saveAttendance"]');
        const originalBtnText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i data-feather="loader" class="mr-2 animate-spin"></i>Saving...';

        fetch(`/api/task/${taskId}/attendance`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                attendance_data: attendanceData,
                date: selectedDate
            })
        })
        .then(response => {
            console.log('Response status:', response.status); // Debug log
            return response.json();
        })
        .then(result => {
            console.log('Save result:', result); // Debug log
            
            // Reset button
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalBtnText;
            
            if (result.error) {
                showCustomModal('Error', result.error, 'error');
            } else {
                // Show detailed success message
                const attendanceCount = attendanceData.length;
                const dateFormatted = new Date(selectedDate + 'T00:00:00').toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                let successMessage;
                if (isPerPart) {
                    const totalUnits = attendanceData.reduce((sum, record) => sum + record.units_completed, 0);
                    successMessage = `Successfully recorded units for ${attendanceCount} worker(s) on ${dateFormatted}. Total units: ${totalUnits}. This data will appear in your reports.`;
                } else {
                    const presentCount = attendanceData.filter(record => record.status === 'Present').length;
                    const absentCount = attendanceData.filter(record => record.status === 'Absent').length;
                    successMessage = `Successfully recorded attendance for ${attendanceCount} worker(s) on ${dateFormatted}. Present: ${presentCount}, Absent: ${absentCount}. This data will appear in your reports.`;
                }
                
                showCustomModal('Attendance Saved', successMessage, 'success');
                
                // Refresh the page to show updated data
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error saving attendance:', error);
            
            // Reset button
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalBtnText;
            
            showCustomModal('Error', 'Failed to save attendance. Please check your internet connection and try again.', 'error');
        });
    }

    function onAttendanceDateChange() {
        const dateInput = document.getElementById('taskDateInput');
        const selected = dateInput.value;
        if (selected) {
            window.location.href = `?date=${selected}`;
        }
    }

    function changeDate(direction) {
        const currentDate = new Date(document.getElementById('taskDateInput').value);
        const minDate = new Date('{{ task_start_date }}');
        currentDate.setDate(currentDate.getDate() + direction);
        if (currentDate < minDate) {
            showAttendanceDateError();
            return;
        }
        const formattedDate = currentDate.toISOString().split('T')[0];
        window.location.href = `?date=${formattedDate}`;
    }

    function showAttendanceDateError() {
        const errorDiv = document.getElementById('attendance-date-error');
        errorDiv.style.display = '';
        errorDiv.classList.remove('hidden');
        errorDiv.scrollIntoView({behavior: 'smooth'});
        setTimeout(() => {
            errorDiv.style.display = 'none';
            errorDiv.classList.add('hidden');
        }, 3500);
    }

    // Search functionality
    function toggleAttendanceSearch() {
        const searchBar = document.getElementById('attendanceSearchBar');
        const searchInput = document.getElementById('attendanceSearchInput');
        const showSearchBtn = document.getElementById('showSearchBtn');

        if (searchBar.classList.contains('hidden')) {
            searchBar.classList.remove('hidden');
            searchInput.focus();
            showSearchBtn.innerHTML = '<i data-feather="x"></i>';
        } else {
            searchBar.classList.add('hidden');
            searchInput.value = ''; // Clear search input
            showSearchBtn.innerHTML = '<i data-feather="search"></i>';
        }
    }

    function filterAttendanceRows() {
        const searchInput = document.getElementById('attendanceSearchInput');
        const searchTerm = searchInput.value.toLowerCase();
        const rows = document.querySelectorAll('#attendanceForm tbody tr');

        rows.forEach(row => {
            const allFields = row.getAttribute('data-worker-fields') || '';
            if (allFields.toLowerCase().includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Handle attendance button clicks
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Task attendance page loaded'); // Debug log
        
        // Add click handlers to all attendance buttons
        const attendanceBtns = document.querySelectorAll('.attendance-btn');
        console.log('Found attendance buttons:', attendanceBtns.length); // Debug log
        
        attendanceBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('Attendance button clicked:', this.className); // Debug log
                
                const label = this.closest('label');
                const radio = label.querySelector('input[type="radio"]');
                const workerButtons = document.querySelectorAll(`input[name="${radio.name}"]`);
                
                // Uncheck all radio buttons for this worker and remove active state
                workerButtons.forEach(r => {
                    r.checked = false;
                    const btn = r.closest('label').querySelector('.attendance-btn');
                    if (btn) {
                        btn.classList.remove('active');
                    }
                });
                
                // Check the clicked radio and activate its button
                radio.checked = true;
                this.classList.add('active');
                
                console.log('Radio button checked:', radio.value); // Debug log
            });
        });

        // Initialize button states based on current radio button values
        const checkedRadios = document.querySelectorAll('input[type="radio"]:checked');
        console.log('Pre-checked radio buttons:', checkedRadios.length); // Debug log
        
        checkedRadios.forEach(radio => {
            const btn = radio.closest('label').querySelector('.attendance-btn');
            if (btn) {
                btn.classList.add('active');
            }
        });
        
        // Re-initialize feather icons
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    });
</script>
{% endblock %}