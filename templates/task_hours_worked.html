{% extends "base_with_sidebar.html" %}

{% block title %}Hours Worked - {{ task.name }} - Embee Accounting{% endblock %}

{% block content %}
<div class="container mx-auto px-4 w-full max-w-6xl pt-8">
    <!-- Desktop header and actions -->
    <div class="hidden lg:flex items-center justify-between mb-6">
        <div>
            <div class="text-2xl font-bold text-primary">
                Hours Worked
            </div>
            <div class="text-lg text-gray-600 mt-1">{{ task.name }}</div>
        </div>
        <div class="flex gap-2">
            <button onclick="openAddWorkerToTaskModal('{{ task.id }}')" class="btn btn-primary">
                <i data-feather="plus" class="mr-2"></i>Add Worker
            </button>
            <a href="{{ url_for('tasks_route') }}" class="btn btn-ghost">
                <i data-feather="arrow-left" class="mr-2"></i>Back to Tasks
            </a>
        </div>
    </div>
    {% if task.payment_type == 'per_hour' and task.per_hour_payout %}
    <div class="flex items-center text-purple-700 font-semibold mb-4">
        <i class="fas fa-clock mr-2"></i>
        <span>Hourly rate: {{ task.per_hour_payout }} {{ task.per_hour_currency or '' }}</span>
    </div>
    {% endif %}
    <!-- Mobile header -->
    <div class="lg:hidden mb-6">
        <div class="text-2xl font-bold text-primary mb-2">
            Hours Worked
        </div>
        <div class="text-lg text-gray-600 mb-4">{{ task.name }}</div>
        <div class="flex flex-col gap-2">
            <button onclick="openAddWorkerToTaskModal('{{ task.id }}')" class="btn btn-primary">
                <i data-feather="plus" class="mr-2"></i>Add Worker
            </button>
            <a href="{{ url_for('tasks_route') }}" class="btn btn-ghost">
                <i data-feather="arrow-left" class="mr-2"></i>Back to Tasks
            </a>
        </div>
    </div>

    <!-- Search icon and bar -->
    <div class="flex justify-end items-center mb-2">
        <button id="showSearchBtn" class="p-2 rounded-full hover:bg-gray-50 focus:outline-none" onclick="toggleHoursSearch()">
            <i data-feather="search"></i>
        </button>
        <div id="hoursSearchBar" class="hidden ml-2 w-full max-w-xs">
            <div class="flex items-center bg-white border border-purple-200 rounded-lg px-2 py-1 shadow">
                <input id="hoursSearchInput" type="text" class="flex-1 outline-none bg-transparent px-2 py-1 text-sm" placeholder="Search by any field..." oninput="filterHoursRows()">
                <button class="ml-2 text-gray-400 hover:text-purple-600" onclick="toggleHoursSearch()" type="button"><i data-feather="x"></i></button>
            </div>
        </div>
    </div>

    {% if selected_date < task.start_date.date() %}
        <div class="alert alert-error mb-4">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            Hours cannot be recorded before the task's start date.
        </div>
        <div class="flex justify-center mb-8">
            <a href="{{ url_for('task_hours_worked_route', task_id=task.id, date=task.start_date.strftime('%Y-%m-%d')) }}" class="btn btn-primary">
                <i class="fas fa-calendar-day mr-2"></i>Back to Today
            </a>
        </div>
    {% elif task.status in ['In Progress', 'Completed'] %}
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <div class="text-center mb-4 flex flex-col items-center justify-center">
                    <div class="flex items-center space-x-6 justify-center w-full">
                        <button 
                            onclick="changeDate(-1)" 
                            class="gradient-circle-btn shadow-md flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-purple-400"
                            aria-label="Previous Day"
                        >
                            <i data-feather="chevron-left" class="w-6 h-6"></i>
                        </button>
                        <h2 class="text-2xl font-bold text-black mx-4">
                            <span id="localDate">{{ selected_date.strftime('%A, %B %d, %Y') }}</span>
                        </h2>
                        <button 
                            onclick="changeDate(1)" 
                            class="gradient-circle-btn shadow-md flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-purple-400"
                            aria-label="Next Day"
                        >
                            <i data-feather="chevron-right" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <input 
                        type="date" 
                        id="taskDateInput" 
                        class="input input-bordered mt-2" 
                        value="{{ selected_date.strftime('%Y-%m-%d') }}"
                        min="{{ task.start_date.strftime('%Y-%m-%d') }}"
                        placeholder="Select task date"
                        onchange="onHoursDateChange()"
                    >
                    <!-- Search icon and bar (moved here, responsive for mobile) -->
                    <div class="flex flex-col sm:flex-row justify-end items-stretch sm:items-center mt-2 w-full gap-2">
                        <div class="flex justify-end items-center w-full sm:max-w-xs mx-auto">
                            <button id="showSearchBtn" class="p-2 rounded-full hover:bg-gray-50 focus:outline-none" onclick="toggleHoursSearch()">
                                <i data-feather="search"></i>
                            </button>
                            <div id="hoursSearchBar" class="hidden ml-2 w-full sm:max-w-xs">
                                <div class="flex items-center bg-white border border-purple-200 rounded-lg px-2 py-1 shadow">
                                    <input id="hoursSearchInput" type="text" class="flex-1 outline-none bg-transparent px-2 py-1 text-sm" placeholder="Search by any field..." oninput="filterHoursRows()">
                                    <button class="ml-2 text-gray-400 hover:text-purple-600" onclick="toggleHoursSearch()" type="button"><i data-feather="x"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="hours-date-error" class="alert alert-error mb-4 hidden" style="display:none;">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    You cannot select a date before the task's start date ({{ task.start_date.strftime('%Y-%m-%d') }}).
                </div>
                <form id="hoursForm">
                    <table class="table w-full">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Hours Worked</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in attendance_records %}
                            <tr
                                data-worker-fields="{{ record.worker.first_name }} {{ record.worker.last_name }}{% if record.worker.date_of_birth %} {{ record.worker.date_of_birth.strftime('%Y-%m-%d') }}{% endif %} {% for cf in record.worker.custom_field_values %} {{ cf.value }}{% endfor %} {{ record.worker.id }}"
                            >
                                <td>{{ record.worker.first_name }} {{ record.worker.last_name }}</td>
                                <td>
                                    <input type="number" min="0" step="0.5" name="hours_{{ record.worker.id }}" class="input input-bordered w-32" value="{{ record.hours_worked if record.hours_worked is not none else '' }}" placeholder="e.g. 8.5" inputmode="decimal">
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div class="mt-4 flex justify-end">
                        <button type="button" onclick="saveHoursWorked('{{ task.id }}')" class="btn btn-primary">
                            <i data-feather="save" class="mr-2"></i>Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
    {% else %}
        <div class="alert alert-info mt-8">
            <i class="fas fa-info-circle mr-2"></i>
            Hours worked is only available for tasks that are In Progress or Completed.
        </div>
    {% endif %}

    {% include 'modals/add_worker_to_task.html' %}
</div>
{% endblock %}

{% block scripts %}
<script>
function saveHoursWorked(taskId) {
    const attendanceData = [];
    const rows = document.querySelectorAll('#hoursForm tbody tr');
    const selectedDate = document.getElementById('taskDateInput').value;
    const taskStartDate = "{{ task.start_date.strftime('%Y-%m-%d') }}";
    
    // Check if selected date is before task start date
    if (selectedDate < taskStartDate) {
        const warning = document.getElementById('hours-date-error');
        warning.style.display = '';
        warning.classList.remove('hidden');
        warning.scrollIntoView({behavior: 'smooth'});
        return;
    } else {
        const warning = document.getElementById('hours-date-error');
        warning.style.display = 'none';
        warning.classList.add('hidden');
    }
    
    rows.forEach(row => {
        const hoursInput = row.querySelector('input[type="number"]');
        if (hoursInput) {
            const hours = hoursInput.value ? parseFloat(hoursInput.value) || 0 : 0;
            attendanceData.push({
                worker_id: hoursInput.name.split('_')[1],
                hours_worked: hours
            });
        }
    });
    
    fetch(`/api/task/${taskId}/attendance`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            attendance_data: attendanceData,
            date: selectedDate
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            showCustomModal('Error', result.error, 'error');
        } else {
            showCustomModal('Success', 'Hours saved successfully', 'success');
        }
    })
    .catch(error => {
        console.error('Error saving hours worked:', error);
        showCustomModal('Error', 'Failed to save hours', 'error');
    });
}

// Search bar logic
function toggleHoursSearch() {
    const searchBar = document.getElementById('hoursSearchBar');
    const searchInput = document.getElementById('hoursSearchInput');
    const showSearchBtn = document.getElementById('showSearchBtn');

    if (searchBar.classList.contains('hidden')) {
        searchBar.classList.remove('hidden');
        searchInput.focus();
        showSearchBtn.innerHTML = '<i data-feather="x"></i>';
        feather.replace();
    } else {
        searchBar.classList.add('hidden');
        searchInput.value = '';
        showSearchBtn.innerHTML = '<i data-feather="search"></i>';
        feather.replace();
    }
}

function filterHoursRows() {
    const searchInput = document.getElementById('hoursSearchInput');
    const searchTerm = searchInput.value.toLowerCase();
    const rows = document.querySelectorAll('#hoursForm tbody tr');

    rows.forEach(row => {
        const allFields = row.getAttribute('data-worker-fields') || '';
        if (allFields.toLowerCase().includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function changeDate(offset) {
    const input = document.getElementById('taskDateInput');
    const currentDate = new Date(input.value);
    currentDate.setDate(currentDate.getDate() + offset);
    const minDate = new Date(input.min);
    
    if (currentDate < minDate) {
        const warning = document.getElementById('hours-date-error');
        warning.style.display = '';
        warning.classList.remove('hidden');
        warning.scrollIntoView({behavior: 'smooth'});
        return;
    }
    
    input.value = currentDate.toISOString().split('T')[0];
    onHoursDateChange();
}

function onHoursDateChange() {
    const input = document.getElementById('taskDateInput');
    const url = new URL(window.location.href);
    url.searchParams.set('date', input.value);
    window.location.href = url.toString();
}

// Initialize feather icons
document.addEventListener('DOMContentLoaded', function() {
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
});
</script>
{% endblock %}
