<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Language Switcher Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/language-switcher-fixes.css') }}">
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        .test-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
        }
        .test-section {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-pass {
            background: #22c55e;
        }
        .status-fail {
            background: #ef4444;
        }
        .status-pending {
            background: #f59e0b;
        }
        .log-entry {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            padding: 4px 8px;
            background: #f3f4f6;
            border-left: 3px solid #3b82f6;
            margin: 4px 0;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="test-container">
        <h1 class="text-3xl font-bold mb-6 text-gray-900">üåê Language Switcher Verification</h1>
        
        <!-- Test Controls -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">Test Controls</h2>
            <div class="flex gap-3 flex-wrap">
                <button onclick="runAllTests()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Run All Tests
                </button>
                <button onclick="testAPIEndpoints()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    Test API
                </button>
                <button onclick="testVisibility()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                    Test Visibility
                </button>
                <button onclick="clearLogs()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                    Clear Logs
                </button>
            </div>
        </div>
        
        <!-- Language Switcher Display -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">Language Switcher Component</h2>
            <div class="flex justify-center p-8 bg-gray-100 rounded-lg">
                {% include 'components/language_switcher.html' %}
            </div>
        </div>
        
        <!-- Test Results -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">Test Results</h2>
            <div id="test-results" class="space-y-2">
                <p class="text-gray-500">Run tests to see results...</p>
            </div>
        </div>
        
        <!-- Console Logs -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">Console Logs</h2>
            <div id="console-logs" class="space-y-1 max-h-96 overflow-y-auto">
                <p class="text-gray-500">Waiting for activity...</p>
            </div>
        </div>
        
        <!-- Current State -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">Current State</h2>
            <div id="current-state" class="space-y-2">
                <div class="flex items-center justify-between py-2 border-b">
                    <span class="font-medium">Session Language:</span>
                    <span id="session-lang" class="text-gray-600">-</span>
                </div>
                <div class="flex items-center justify-between py-2 border-b">
                    <span class="font-medium">API Current Language:</span>
                    <span id="api-lang" class="text-gray-600">-</span>
                </div>
                <div class="flex items-center justify-between py-2 border-b">
                    <span class="font-medium">Dropdown Visible:</span>
                    <span id="dropdown-visible" class="text-gray-600">-</span>
                </div>
                <div class="flex items-center justify-between py-2">
                    <span class="font-medium">Available Languages:</span>
                    <span id="available-langs" class="text-gray-600">-</span>
                </div>
            </div>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/language-switcher.js') }}"></script>
    <script>
        let testResults = [];
        
        // Intercept console logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addLog(type, message) {
            const logContainer = document.getElementById('console-logs');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : 'üìù';
            logEntry.textContent = `${icon} [${timestamp}] ${message}`;
            
            if (type === 'error') logEntry.style.borderLeftColor = '#ef4444';
            if (type === 'warn') logEntry.style.borderLeftColor = '#f59e0b';
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog('log', args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('error', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLog('warn', args.join(' '));
        };
        
        function clearLogs() {
            document.getElementById('console-logs').innerHTML = '<p class="text-gray-500">Logs cleared...</p>';
        }
        
        function addTestResult(name, passed, message) {
            testResults.push({ name, passed, message });
            updateTestResults();
        }
        
        function updateTestResults() {
            const container = document.getElementById('test-results');
            container.innerHTML = testResults.map(result => `
                <div class="flex items-start py-2 border-b">
                    <span class="status-indicator ${result.passed ? 'status-pass' : 'status-fail'}"></span>
                    <div class="flex-1">
                        <div class="font-medium">${result.name}</div>
                        <div class="text-sm text-gray-600">${result.message}</div>
                    </div>
                </div>
            `).join('');
        }
        
        async function testAPIEndpoints() {
            console.log('Testing API endpoints...');
            
            // Test 1: Get languages
            try {
                const response = await fetch('/api/languages');
                const data = await response.json();
                
                if (response.ok && data.languages) {
                    addTestResult('GET /api/languages', true, `Retrieved ${Object.keys(data.languages).length} languages. Current: ${data.current_language}`);
                    updateCurrentState(data);
                } else {
                    addTestResult('GET /api/languages', false, `Failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                addTestResult('GET /api/languages', false, `Error: ${error.message}`);
            }
            
            // Test 2: Change language
            try {
                const testLang = 'fr';
                const response = await fetch('/api/change-language', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ language: testLang })
                });
                const data = await response.json();
                
                if (response.ok && data.success) {
                    addTestResult('POST /api/change-language', true, `Successfully changed to ${testLang}`);
                    
                    // Verify the change
                    const verifyResponse = await fetch('/api/languages');
                    const verifyData = await verifyResponse.json();
                    
                    if (verifyData.current_language === testLang) {
                        addTestResult('Language Change Verification', true, `Confirmed language is now ${testLang}`);
                    } else {
                        addTestResult('Language Change Verification', false, `Expected ${testLang}, got ${verifyData.current_language}`);
                    }
                    
                    updateCurrentState(verifyData);
                } else {
                    addTestResult('POST /api/change-language', false, `Failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                addTestResult('POST /api/change-language', false, `Error: ${error.message}`);
            }
        }
        
        function testVisibility() {
            console.log('Testing dropdown visibility...');
            
            const button = document.querySelector('.language-switcher-btn');
            const menu = document.querySelector('.language-menu');
            
            if (!button || !menu) {
                addTestResult('Component Presence', false, 'Button or menu not found');
                return;
            }
            
            addTestResult('Component Presence', true, 'Button and menu elements found');
            
            // Test initial state
            const initiallyVisible = window.getComputedStyle(menu).display !== 'none';
            addTestResult('Initial State', !initiallyVisible, initiallyVisible ? 'Menu should be hidden initially' : 'Menu correctly hidden');
            
            // Test click to open
            console.log('Clicking button to open menu...');
            button.click();
            
            setTimeout(() => {
                const isVisible = menu.classList.contains('visible') && menu.classList.contains('opacity-100');
                const computedDisplay = window.getComputedStyle(menu).display;
                const ariaExpanded = button.getAttribute('aria-expanded');
                
                addTestResult('Menu Opens on Click', isVisible && computedDisplay === 'block', 
                    `Visible: ${isVisible}, Display: ${computedDisplay}, ARIA: ${ariaExpanded}`);
                
                // Update state display
                document.getElementById('dropdown-visible').textContent = isVisible ? 'Yes ‚úì' : 'No ‚úó';
                
                // Click outside to close
                console.log('Clicking outside to close menu...');
                document.body.click();
                
                setTimeout(() => {
                    const isClosed = !menu.classList.contains('visible');
                    addTestResult('Menu Closes on Outside Click', isClosed, 
                        isClosed ? 'Menu closed successfully' : 'Menu did not close');
                    
                    document.getElementById('dropdown-visible').textContent = 'No ‚úì';
                }, 300);
            }, 300);
        }
        
        function updateCurrentState(data) {
            if (data.current_language) {
                document.getElementById('session-lang').textContent = data.current_language;
                document.getElementById('api-lang').textContent = data.current_language;
            }
            
            if (data.languages) {
                const langCount = Object.keys(data.languages).length;
                const langList = Object.entries(data.languages).map(([code, name]) => `${code}: ${name}`).join(', ');
                document.getElementById('available-langs').textContent = `${langCount} (${langList})`;
            }
        }
        
        async function runAllTests() {
            console.log('Running all tests...');
            testResults = [];
            
            await testAPIEndpoints();
            
            setTimeout(() => {
                testVisibility();
            }, 1000);
        }
        
        // Run initial state check on load
        window.addEventListener('load', async () => {
            console.log('Page loaded, checking initial state...');
            
            try {
                const response = await fetch('/api/languages');
                const data = await response.json();
                updateCurrentState(data);
                console.log('Initial state loaded successfully');
            } catch (error) {
                console.error('Failed to load initial state:', error);
            }
        });
    </script>
</body>
</html>
