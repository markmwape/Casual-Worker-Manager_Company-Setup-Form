<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Language Switcher Test</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { padding: 20px; font-family: system-ui; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .current-lang { font-weight: bold; color: #2563eb; }
        
        /* Ensure buttons are clickable */
        .language-switcher-btn {
            pointer-events: auto !important;
            cursor: pointer !important;
            user-select: none;
            border: 2px solid #e2e8f0 !important;
            background: white !important;
            color: #1e293b !important;
        }
        
        .language-switcher-btn:hover {
            background: #f8f9fa !important;
            border-color: #cbd5e1 !important;
        }
        
        .language-switcher-btn:active {
            background: #f1f5f9 !important;
        }
        
        /* Dropdown arrow animation */
        .dropdown-arrow {
            transition: transform 0.2s ease;
        }
        
        .dropdown.dropdown-open .dropdown-arrow {
            transform: rotate(180deg);
        }
        
        /* Ensure dropdowns are visible */
        .language-menu {
            position: absolute;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 1000;
            min-width: 200px;
        }
        
        /* Test logging area */
        #testLog {
            max-height: 300px;
            overflow-y: auto;
            background: #f5f5f5;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>Language Switcher Test</h1>
    
    <div class="test-section">
        <h2>Desktop Language Switcher</h2>
        <!-- Include the fixed language switcher -->
        <!-- Language Switcher Component -->
        <div class="language-switcher-container">
            <div class="dropdown dropdown-end">
                <button type="button" class="btn btn-sm gap-2 language-switcher-btn language-toggle">
                    <span class="text-xl">üåê</span>
                    <span class="current-lang-label font-semibold text-sm">English</span>
                    <svg class="w-4 h-4 transition-transform dropdown-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <ul class="dropdown-content z-[300] menu p-2 shadow-xl bg-white border border-gray-200 rounded-lg w-56 mt-2 language-menu" style="display: none;">
                    <!-- Will be populated by JavaScript -->
                </ul>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Mobile Menu Language Switcher</h2>
        <div class="mobile-menu-language-switcher">
            <div class="language-switcher-container">
                <div class="dropdown dropdown-end">
                    <button type="button" class="btn btn-sm gap-2 language-switcher-btn language-toggle">
                        <span class="text-xl">üåê</span>
                        <span class="current-lang-label font-semibold text-sm">English</span>
                        <svg class="w-4 h-4 transition-transform dropdown-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <ul class="dropdown-content z-[300] menu p-2 shadow-xl bg-white border border-gray-200 rounded-lg w-56 mt-2 language-menu" style="display: none;">
                        <!-- Will be populated by JavaScript -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Sidebar Language Switcher</h2>
        <div class="sidebar-language-switcher">
            <div class="language-switcher-container">
                <div class="dropdown dropdown-end">
                    <button type="button" class="btn btn-sm gap-2 language-switcher-btn language-toggle">
                        <span class="text-xl">üåê</span>
                        <span class="current-lang-label font-semibold text-sm">English</span>
                        <svg class="w-4 h-4 transition-transform dropdown-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <ul class="dropdown-content z-[300] menu p-2 shadow-xl bg-white border border-gray-200 rounded-lg w-56 mt-2 language-menu" style="display: none;">
                        <!-- Will be populated by JavaScript -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Test Log</h2>
        <div id="testLog" style="max-height: 200px; overflow-y: auto; background: #f5f5f5; padding: 10px; font-family: monospace;"></div>
    </div>

    <script>
        // Mock the API responses for testing
        function mockFetch(url, options) {
            if (url === '/api/languages') {
                return Promise.resolve({
                    ok: true,
                    json: () => Promise.resolve({
                        languages: {
                            'en': 'English',
                            'fr': 'Fran√ßais',
                            'sw': 'Swahili',
                            'pt': 'Portugu√™s',
                            'es': 'Espa√±ol',
                            'tr': 'T√ºrk√ße',
                            'hi': '‡§π‡§ø‡§Ç‡§¶‡•Ä',
                            'zh': '‰∏≠Êñá',
                            'ar': 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©',
                            'vi': 'Ti·∫øng Vi·ªát'
                        },
                        current_language: 'en'
                    })
                });
            } else if (url === '/api/change-language' && options && options.method === 'POST') {
                const body = JSON.parse(options.body);
                return Promise.resolve({
                    ok: true,
                    json: () => Promise.resolve({
                        success: true,
                        language: body.language
                    })
                });
            }
            return Promise.reject(new Error('Unknown API endpoint'));
        }
        
        // Override fetch for testing
        window.fetch = mockFetch;
        
        // Test logging
        function log(message) {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        // Include the fixed language switcher JavaScript
        // Initialize language switcher - handles multiple instances
        function initLanguageSwitcher() {
            try {
                log('Initializing language switcher...');
                
                // Fetch available languages
                fetch('/api/languages')
                    .then(response => {
                        log('Languages response status: ' + response.status);
                        return response.json();
                    })
                    .then(data => {
                        log('Languages data received: ' + JSON.stringify(data));
                        const languages = data.languages || {};
                        const currentLanguage = data.current_language || 'en';
                        
                        // Update all language menus (handle multiple instances)
                        const languageMenus = document.querySelectorAll('.language-menu');
                        languageMenus.forEach((languageMenu, index) => {
                            if (languageMenu) {
                                languageMenu.innerHTML = ''; // Clear existing items
                                let itemCount = 0;
                                for (const [code, name] of Object.entries(languages)) {
                                    const li = document.createElement('li');
                                    const a = document.createElement('a');
                                    a.textContent = name;
                                    a.href = 'javascript:void(0)';
                                    a.setAttribute('data-lang', code);
                                    a.style.cursor = 'pointer';
                                    
                                    // Add click handler
                                    a.addEventListener('click', function(e) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        const lang = this.getAttribute('data-lang');
                                        log('Language clicked: ' + lang + ' (' + name + ')');
                                        changeLanguage(lang);
                                        
                                        // Close all dropdowns
                                        document.querySelectorAll('.language-menu').forEach(menu => {
                                            menu.style.display = 'none';
                                        });
                                    });
                                    
                                    if (code === currentLanguage) {
                                        a.classList.add('active', 'font-bold');
                                        a.style.backgroundColor = '#3b82f6';
                                        a.style.color = 'white';
                                    }
                                    
                                    li.appendChild(a);
                                    languageMenu.appendChild(li);
                                    itemCount++;
                                }
                                log(`Language menu ${index + 1} populated with ${itemCount} languages`);
                            }
                        });
                        
                        // Update all current language labels
                        const currentLangLabels = document.querySelectorAll('.current-lang-label');
                        currentLangLabels.forEach((label, index) => {
                            if (label && languages[currentLanguage]) {
                                label.textContent = languages[currentLanguage];
                                log(`Current language label ${index + 1} updated to: ${languages[currentLanguage]}`);
                            }
                        });
                    })
                    .catch(error => {
                        log('Error loading languages: ' + error.message);
                    });
            } catch (error) {
                log('Error initializing language switcher: ' + error.message);
            }
        }
        
        // Change language function
        function changeLanguage(langCode) {
            log('Changing language to: ' + langCode);
            
            // Show loading state
            const currentLangLabels = document.querySelectorAll('.current-lang-label');
            currentLangLabels.forEach(label => {
                label.textContent = 'Changing...';
            });
            
            try {
                fetch('/api/change-language', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ language: langCode })
                })
                .then(response => {
                    log('Change language response status: ' + response.status);
                    return response.json();
                })
                .then(result => {
                    if (result.success) {
                        log('Language changed successfully, updating page...');
                        
                        // Update labels immediately
                        const languageNames = {
                            'en': 'English',
                            'fr': 'Fran√ßais',
                            'sw': 'Swahili', 
                            'pt': 'Portugu√™s',
                            'es': 'Espa√±ol',
                            'tr': 'T√ºrk√ße',
                            'hi': '‡§π‡§ø‡§Ç‡§¶‡•Ä',
                            'zh': '‰∏≠Êñá',
                            'ar': 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©',
                            'vi': 'Ti·∫øng Vi·ªát'
                        };
                        
                        currentLangLabels.forEach(label => {
                            label.textContent = languageNames[langCode] || langCode.toUpperCase();
                        });
                        
                        // Update active states
                        document.querySelectorAll('.language-menu a').forEach(link => {
                            link.classList.remove('active', 'font-bold');
                            link.style.backgroundColor = '';
                            link.style.color = '';
                            if (link.getAttribute('data-lang') === langCode) {
                                link.classList.add('active', 'font-bold');
                                link.style.backgroundColor = '#3b82f6';
                                link.style.color = 'white';
                            }
                        });
                        
                        log('Language switch completed successfully');
                    } else {
                        log('Error response from change-language endpoint: ' + JSON.stringify(result));
                    }
                });
            } catch (error) {
                log('Error in changeLanguage function: ' + error.message);
            }
        }
        
        // Add dropdown behavior handlers
        function setupDropdownBehavior() {
            log('Setting up dropdown behavior...');
            
            // Handle dropdown toggle behavior with improved button handling
            document.querySelectorAll('.language-toggle').forEach((toggle, index) => {
                log(`Setting up click handler for toggle ${index + 1}`);
                
                // Ensure button is clickable
                toggle.style.pointerEvents = 'auto';
                toggle.style.cursor = 'pointer';
                
                // Remove any existing event listeners by cloning the element
                const newToggle = toggle.cloneNode(true);
                toggle.parentNode.replaceChild(newToggle, toggle);
                
                newToggle.addEventListener('click', function(e) {
                    log(`Language switcher button ${index + 1} clicked!`);
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const dropdown = this.closest('.dropdown');
                    const menu = dropdown.querySelector('.language-menu');
                    
                    if (!dropdown || !menu) {
                        log('Error: Could not find dropdown or menu elements');
                        return;
                    }
                    
                    // Close other dropdowns first
                    document.querySelectorAll('.dropdown').forEach(otherDropdown => {
                        if (otherDropdown !== dropdown) {
                            const otherMenu = otherDropdown.querySelector('.language-menu');
                            if (otherMenu) {
                                otherMenu.style.display = 'none';
                                otherDropdown.classList.remove('dropdown-open');
                            }
                        }
                    });
                    
                    // Toggle current dropdown
                    const isVisible = menu.style.display === 'block';
                    if (isVisible) {
                        menu.style.display = 'none';
                        dropdown.classList.remove('dropdown-open');
                        log(`Dropdown ${index + 1} closed`);
                    } else {
                        menu.style.display = 'block';
                        dropdown.classList.add('dropdown-open');
                        log(`Dropdown ${index + 1} opened`);
                        
                        // Position the menu properly
                        const rect = this.getBoundingClientRect();
                        const menuRect = menu.getBoundingClientRect();
                        
                        // Adjust positioning if menu would go off-screen
                        if (rect.bottom + menuRect.height > window.innerHeight) {
                            menu.style.bottom = '100%';
                            menu.style.top = 'auto';
                            menu.style.marginBottom = '0.5rem';
                            menu.style.marginTop = '0';
                        } else {
                            menu.style.top = '100%';
                            menu.style.bottom = 'auto';
                            menu.style.marginTop = '0.5rem';
                            menu.style.marginBottom = '0';
                        }
                    }
                });
                
                // Add keyboard support
                newToggle.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        log(`Language switcher keyboard activated: ${e.key}`);
                        this.click();
                    }
                });
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.language-switcher-container')) {
                    document.querySelectorAll('.language-menu').forEach(menu => {
                        menu.style.display = 'none';
                    });
                }
            });
            log('Dropdown behavior setup completed');
        }
        
        // Initialize everything
        function initLanguageSwitcherComplete() {
            initLanguageSwitcher();
            setupDropdownBehavior();
        }
        
        // Initialize on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initLanguageSwitcherComplete);
        } else {
            // DOM already loaded
            initLanguageSwitcherComplete();
        }
        
        // Start test
        log('Language switcher test page loaded');
    </script>
</body>
</html>
